<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Relat√≥rio Din√¢mico ‚Äì Wyckoff/Fibonacci (v5.4 - Estrat√©gico Completo)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        :root {
            --bg-body: #f5f7fa;
            --bg-card: #ffffff;
            --bg-card-alt: #f7f9fc;
            --border-card: #e2e8f0;
            --border-soft: #e5ecf5;
            --text-main: #1e2733;
            --text-muted: #6b7280;
            --accent: #3861fb;
            --accent-soft: rgba(56, 97, 251, 0.08);
            --accent-strong: #1b44d1;
            --positive: #16a34a;
            --negative: #dc2626;
            --neutral: #f59e0b;
            --resistance: #dc2626; 
            --support: #16a34a; 

            --score-high: #16a34a;
            --score-mid: #f97316;
            --score-low: #dc2626;

            --shadow-soft: 0 10px 30px rgba(15,23,42,0.08);
        }

        * {
            box-sizing: border-box;
            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        body {
            margin: 0;
            background: var(--bg-body);
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
            padding: 10px;
        }

        h1 {
            margin: 8px 0 4px;
            font-size: 1.3rem;
            font-weight: 700;
            text-align: center;
            color: var(--text-main);
        }

        .subtitle {
            text-align: center;
            font-size: 0.78rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .disclaimer {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 10px;
            font-size: 0.78rem;
            color: var(--text-muted);
            border: 1px solid var(--border-card);
            box-shadow: var(--shadow-soft);
            margin-bottom: 10px;
        }

        .disclaimer strong {
            color: var(--text-main);
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .top-bar button {
            border: none;
            border-radius: 999px;
            padding: 6px 12px;
            background: var(--accent);
            color: #ffffff;
            font-weight: 600;
            font-size: 0.78rem;
            cursor: pointer;
            box-shadow: 0 6px 16px rgba(56,97,251,0.25);
        }

        .top-bar button.secondary {
            background: #ffffff;
            color: var(--text-main);
            border: 1px solid var(--border-card);
            box-shadow: none;
        }

        .top-bar button:active {
            transform: translateY(1px);
        }

        #auto-refresh-status {
            font-size: 0.72rem;
            color: var(--text-muted);
        }

        .countdown-display {
            font-weight: 600;
            color: var(--accent-strong);
        }

        .search-input {
            width: 100%;
            padding: 7px 12px;
            border-radius: 999px;
            border: 1px solid var(--border-card);
            background: #ffffff;
            color: var(--text-main);
            font-size: 0.8rem;
            margin-bottom: 8px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(56,97,251,0.25);
        }

        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
            font-size: 0.75rem;
        }

        .filter-group label {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid var(--border-card);
            background: var(--bg-card);
            color: var(--text-muted);
        }

        .filter-group input[type="radio"] {
            accent-color: var(--accent);
        }

        .filter-group label.active {
            border-color: var(--accent);
            background: var(--accent-soft);
            color: var(--accent-strong);
            font-weight: 600;
        }

        #card-container {
            margin-top: 6px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-card);
            margin-bottom: 10px;
            padding: 10px;
            box-shadow: var(--shadow-soft);
            position: relative;
        }

        /* NOVO: Bot√£o de exclus√£o no card */
        .remove-card-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: var(--negative);
            font-size: 1.1rem;
            line-height: 1;
            cursor: pointer;
            padding: 5px;
            opacity: 0.5;
            transition: opacity 0.2s;
            z-index: 10;
        }
        .remove-card-btn:hover {
            opacity: 1;
        }

        .card-header {
            display: flex;
            align-items: flex-start; /* Alinha no topo por causa do bot√£o X */
            justify-content: space-between;
            gap: 6px;
        }

        .card-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ticker {
            font-weight: 700;
            font-size: 0.95rem;
        }

        .token-name {
            font-size: 0.73rem;
            color: var(--text-muted);
        }
        
        .token-info-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .token-rank {
            font-size: 0.7rem;
            padding: 1px 6px;
            border-radius: 4px;
            background: var(--bg-card-alt);
            border: 1px solid var(--border-soft);
            color: var(--text-muted);
        }

        .badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 999px;
            background: var(--accent-soft);
            border: 1px solid rgba(56,97,251,0.3);
            color: var(--accent-strong);
            white-space: nowrap;
        }

        .price {
            font-size: 0.95rem;
            font-weight: 600;
            text-align: right;
            cursor: pointer;
            white-space: nowrap; /* Impede quebra de linha */
        }
        
        .price-change {
            display: none; 
        }

        .positive {
            color: var(--positive);
        }

        .negative {
            color: var(--negative);
        }

        .neutral {
            color: var(--neutral);
        }
        
        .change-metric-value.positive {
            background: rgba(22,163,74,0.08);
        }

        .change-metric-value.negative {
            background: rgba(220,38,38,0.08);
        }

        .change-metric-value.neutral {
            background: rgba(245,158,11,0.08);
        }

        .card-main-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-top: 6px;
            gap: 8px;
        }

        .main-metrics {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.78rem;
            width: 60%;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            gap: 6px;
        }
        
        .momentum-group, .alpha-group { /* NOVO: Alpha group para destaque */
            border: 1px solid var(--border-soft);
            border-radius: 8px;
            padding: 6px 8px;
            margin-bottom: 4px; 
        }

        .metric-row.metric-clickable {
            cursor: pointer;
        }

        .metric-label {
            color: var(--text-muted);
            cursor: pointer;
        }

        .metric-value {
            font-weight: 500;
            text-align: right;
            cursor: pointer;
        }

        .rsi-high { color: var(--negative); font-weight: 600; }
        .rsi-low { color: var(--positive); font-weight: 600; }
        
        .sr-support { color: var(--support); font-weight: 600; }
        .sr-resistance { color: var(--resistance); font-weight: 600; }

        .score-badge {
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 0.75rem;
            color: #ffffff;
        }
        .score-high { background: var(--score-high); }
        .score-mid  { background: var(--score-mid); }
        .score-low  { background: var(--score-low); }

        .sparkline-wrapper {
            width: 40%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        canvas.sparkline {
            width: 100%;
            height: 40px;
        }

        /* Oculta os detalhes para a vers√£o enxuta, mas permite o bot√£o Trade */
        .card-toggle {
            display: none; 
        }

        .card-details {
            margin-top: 8px;
            display: block; 
            border-top: 1px dashed var(--border-soft);
            padding-top: 8px;
        }

        .detail-grid {
            display: none; 
        }

        .wyckoff-tag {
            margin-top: 8px;
            font-size: 0.72rem;
            color: var(--text-muted);
        }

        .wyckoff-tag strong {
            color: var(--text-main);
        }

        .tradingview-container {
            margin-top: 10px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--border-soft);
            background: #ffffff;
            height: 240px;
            display: none; 
        }
        
        .card.expanded .tradingview-container {
            display: block;
        }
        
        .alert-trade-section {
            margin-top: 10px;
            padding: 8px;
            border-radius: 8px;
            background: var(--bg-card-alt);
            border: 1px dashed var(--border-soft);
        }


        .ranking-dashboard {
            margin-top: 14px;
            padding: 10px;
            border-radius: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-card);
            box-shadow: var(--shadow-soft);
            font-size: 0.75rem;
        }

        .ranking-dashboard h3 {
            margin: 0 0 4px;
            font-size: 0.85rem;
            color: var(--text-main);
        }

        .ranking-filters {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .ranking-columns {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
            margin-top: 4px;
        }

        .ranking-card {
            padding: 6px;
            border-radius: 8px;
            background: var(--bg-card-alt);
            border: 1px solid var(--border-soft);
        }

        .ranking-card h4 {
            margin: 0 0 4px;
            font-size: 0.78rem;
            color: var(--text-main);
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
            cursor: pointer;
        }

        .ranking-item span:last-child {
            font-weight: 600;
        }

        .alert-trade-section h4 {
            margin: 0 0 6px;
            font-size: 0.8rem;
            color: var(--accent-strong);
        }

        .trade-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .trade-buttons button {
            flex-grow: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.75rem;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .trade-buttons button:active {
            transform: scale(0.98);
        }

        .trade-buttons .btn-buy {
            background-color: var(--positive);
            color: #ffffff;
        }

        .trade-buttons .btn-sell {
            background-color: var(--negative);
            color: #ffffff;
        }
        
        /* Estilos para a nova √°rea de trade */
        .trade-form-group {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .trade-form-group input, .trade-form-group select {
            flex-grow: 1;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid var(--border-card);
            font-size: 0.75rem;
            width: 50%;
        }

        .trade-form button {
            width: 100%;
            padding: 6px;
            border: none;
            border-radius: 6px;
            background: var(--accent);
            color: #ffffff;
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .active-alerts-list, .trade-history-list {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 6px;
            padding-top: 4px;
            border-top: 1px dotted var(--border-soft);
        }

        .history-item, .alert-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 0;
            border-bottom: 1px dotted rgba(107, 114, 128, 0.2);
        }

        .history-item:last-child, .alert-item:last-child {
            border-bottom: none;
        }

        .history-item span:first-child, .alert-item span:first-child {
            flex-grow: 1;
            font-weight: 500;
        }

        .history-item .val-positive { color: var(--positive); font-weight: 700; }
        .history-item .val-negative { color: var(--negative); font-weight: 700; }
        
        .history-pnl {
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }


        .remove-btn {
            background: transparent;
            border: none;
            color: var(--negative);
            font-size: 0.65rem;
            cursor: pointer;
            padding: 2px 4px;
            margin-left: 5px;
            opacity: 0.7;
        }
        .remove-btn:hover { opacity: 1; }
        
        .add-btn {
            background: var(--positive);
            border: none;
            color: white;
            font-size: 0.65rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            white-space: nowrap;
        }
        
        /* --- Modal de Confirma√ß√£o --- */
        #confirm-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        #confirm-modal-overlay.active {
            display: flex;
        }

        .confirm-modal-content {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 350px;
            box-shadow: var(--shadow-soft);
            text-align: center;
        }

        .confirm-modal-content h4 {
            margin: 0 0 10px;
            font-size: 1rem;
            color: var(--text-main);
        }

        .confirm-modal-content p {
            margin: 0 0 20px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-buttons button {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            flex-grow: 1;
        }

        .btn-cancel {
            background: var(--bg-card-alt);
            color: var(--text-main);
            border: 1px solid var(--border-soft);
        }

        .btn-confirm-delete {
            background: var(--negative);
            color: white;
        }
        /* --- Fim Modal de Confirma√ß√£o --- */

        #toast-container {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            max-width: 90%;
        }

        .toast {
            background-color: #111827;
            color: #f9fafb;
            border-radius: 8px;
            padding: 8px 10px;
            margin-top: 6px;
            box-shadow: 0 8px 24px rgba(15,23,42,0.4);
            border: 1px solid #1f2937;
            opacity: 0;
            transform: translateY(8px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            font-size: 0.75rem;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .metric-tooltip-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.35);
            display: none;
            align-items: flex-end;
            justify-content: center;
            z-index: 1100;
        }

        .metric-tooltip-overlay.active {
            display: flex;
        }

        .metric-tooltip-panel {
            width: 100%;
            max-width: 650px;
            background: #ffffff;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 -10px 30px rgba(15,23,42,0.3);
            padding: 10px 12px 12px;
            max-height: 55vh;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.18s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .metric-tooltip-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 6px;
        }

        .metric-tooltip-title {
            font-size: 0.86rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .metric-tooltip-close {
            border: none;
            border-radius: 999px;
            padding: 5px 10px;
            background: var(--bg-card-alt);
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
        }

        .metric-tooltip-body {
            font-size: 0.78rem;
            color: var(--text-main);
            overflow-y: auto;
            padding-right: 4px;
        }

        .metric-tooltip-body strong {
            color: var(--accent-strong);
        }

        /* Novo estilo para a dashboard de destaques */
        #dashboard-highlights {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-card);
            box-shadow: var(--shadow-soft);
        }

        #dashboard-highlights h3 {
            margin: 0 0 8px;
            font-size: 0.85rem;
            color: var(--text-main);
            border-bottom: 1px solid var(--border-soft);
            padding-bottom: 4px;
        }

        .highlight-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .highlight-card {
            font-size: 0.75rem;
            padding: 6px;
            border-radius: 8px;
            background: var(--bg-card-alt);
            border: 1px solid var(--border-soft);
        }

        .highlight-card h4 {
            margin: 0 0 4px;
            font-size: 0.78rem;
            color: var(--accent-strong);
        }

        .highlight-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
            cursor: pointer;
            position: relative;
        }

        .highlight-item span:last-child {
            font-weight: 600;
        }

        .highlight-item .positive { color: var(--positive); }
        .highlight-item .negative { color: var(--negative); }

        /* Estilos para os bot√µes de navega√ß√£o (Scroll) */
        .scroll-button-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .scroll-button {
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(56, 97, 251, 0.4);
            transition: background-color 0.2s;
        }

        .scroll-button:hover {
            background-color: var(--accent-strong);
        }
        
        .token-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px dotted var(--border-soft);
        }

        @media (min-width: 768px) {
            body {
                max-width: 650px;
                margin: 0 auto;
            }
            .highlight-grid {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body>
    <h1>Relat√≥rio Din√¢mico ‚Äì Wyckoff/Fibonacci (Vers√£o Estrat√©gica)</h1>
    <div class="subtitle">
        Foco nos 4 indicadores mais eficientes para tomada de decis√£o (S/R, Alpha, RSI e Score de Atra√ß√£o).
    </div>

    <div class="disclaimer">
        <p style="margin:0 0 4px;">
            Este painel √© **exclusivamente educacional** e **n√£o √© uma corretora real**. Os registros de compra/venda s√£o **SIMULADOS**.
            N√£o constitui, em hip√≥tese alguma, recomenda√ß√£o de compra ou venda de ativos.
        </p>
        <p id="last-update" style="font-size:0.74rem; margin:0; color:var(--text-muted);">
            √öltima atualiza√ß√£o: carregando...
        </p>
    </div>

    <div class="top-bar">
        <div style="display:flex; gap:6px;">
            <button id="refresh-button">Atualizar agora</button>
        </div>
        <div id="auto-refresh-status">
            Atualiza√ß√£o autom√°tica em: <span id="countdown" class="countdown-display">--</span>
        </div>
    </div>

    <div id="dashboard-highlights">
        <h3>üèÜ Destaques de Mercado (Top 10 - 24h e Assimetria)</h3>
        <div class="highlight-grid" id="highlight-content">
            </div>
    </div>
    <input type="text" id="search-input" class="search-input"
           placeholder="Buscar por ticker ou nome (ex: BTC, Kaspa, Pendle)...">

    <div class="filter-group" id="wyckoff-filter-group">
        <label class="active">
            <input type="radio" name="wyckoff-filter" value="all" checked>
            Todas as fases
        </label>
        <label>
            <input type="radio" name="wyckoff-filter" value="acc">
            Fases de compra (Acum.)
        </label>
        <label>
            <input type="radio" name="wyckoff-filter" value="dist">
            Fases de venda (Dist.)
        </label>
        <label>
            <input type="radio" name="wyckoff-filter" value="neutro">
            Fases neutras/laterais
        </label>
    </div>

    <div id="token-management-dashboard" class="ranking-dashboard" style="margin-top:10px;">
        <h3>‚ûï Gerenciar Tokens (Adicionar/Remover)</h3>
        <input type="text" id="token-search-input" class="search-input"
               placeholder="Buscar no CoinGecko (ex: Solana, SOL, pepe)...">
        <div id="token-search-results" style="margin-bottom: 8px; font-size: 0.75rem;"></div>
        
        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 6px; border-top: 1px dashed var(--border-soft); padding-top: 6px;">
            Tokens Ativos (clique no ticker para remover os que voc√™ adicionou): <span id="active-tokens-list"></span>
        </div>
    </div>

    <div id="card-container"></div>

    <div id="ranking-dashboard" class="ranking-dashboard">
        <h3>Dashboard de oportunidades (vis√£o geral)</h3>
        <div class="ranking-filters">
            Toque em qualquer linha do ranking para abrir o card correspondente e ver os detalhes Wyckoff/Fibonacci.
        </div>

        <div class="filter-group" id="dashboard-filter-group" style="margin-top:6px;">
            <label class="active">
                <input type="radio" name="dashboard-filter" value="geral" checked>
                Ranking geral
            </label>
            <label>
                <input type="radio" name="dashboard-filter" value="compra">
                Foco em compras
            </label>
            <label>
                <input type="radio" name="dashboard-filter" value="venda">
                Foco em vendas
            </label>
        </div>

        <div id="ranking-content"></div>
    </div>

    <div id="toast-container"></div>

    <div class="scroll-button-container">
        <button id="scroll-to-top" class="scroll-button" aria-label="Ir para o topo">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>
        </button>
        <button id="scroll-to-bottom" class="scroll-button" aria-label="Ir para o rodap√©">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
        </button>
    </div>

    <div id="confirm-modal-overlay">
        <div class="confirm-modal-content">
            <h4 id="modal-title">Confirmar Exclus√£o</h4>
            <p id="modal-message">Voc√™ tem certeza que deseja remover o token X da sua lista? Esta a√ß√£o √© irrevers√≠vel.</p>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeConfirmModal()">Cancelar</button>
                <button class="btn-confirm-delete">Sim, Excluir</button>
            </div>
        </div>
    </div>

    <div id="metric-tooltip-overlay" class="metric-tooltip-overlay">
        <div class="metric-tooltip-panel">
            <div class="metric-tooltip-header">
                <div id="metric-tooltip-title" class="metric-tooltip-title">M√©trica</div>
                <button id="metric-tooltip-close" class="metric-tooltip-close">Fechar</button>
            </div>
            <div id="metric-tooltip-body"></div>
        </div>
    </div>

    <script src="https://s3.tradingview.com/tv.js"></script>
    <script>
        const CARD_CONTAINER = document.getElementById('card-container');
        const RANKING_CONTAINER = document.getElementById('ranking-content');
        const HIGHLIGHT_CONTAINER = document.getElementById('highlight-content');
        const TOKEN_SEARCH_INPUT = document.getElementById('token-search-input');
        const TOKEN_SEARCH_RESULTS = document.getElementById('token-search-results');
        const ACTIVE_TOKENS_LIST_EL = document.getElementById('active-tokens-list');
        const CONFIRM_MODAL_OVERLAY = document.getElementById('confirm-modal-overlay');
        const BTN_CONFIRM_DELETE = document.querySelector('.btn-confirm-delete');

        const API_BASE = 'https://api.coingecko.com/api/v3';
        const MARKETS_ENDPOINT = '/coins/markets';
        
        const REFRESH_INTERVAL_MS = 60000;
        const MAX_RETRIES = 3;
        const USER_TOKENS_STORAGE_KEY = 'wyckoff_user_tokens_v1';
        const USER_TRADES_STORAGE_KEY = 'wyckoff_trades_v2'; // Chave atualizada

        let allCryptoData = [];
        let btcPrice = null; 
        let btc1hChange = null; // Novo: Alpha 1h
        let btc24hChange = null;
        let btc7dChange = null; 
        let btc30dChange = null;
        let btc1yChange = null; 
        
        let refreshTimer = null;
        let countdownTimer = null;
        let countdownSeconds = REFRESH_INTERVAL_MS / 1000;
        let activeAlerts = {};
        let tradeHistory = {};
        let currentWyckoffFilter = 'all';
        let currentDashboardFilter = 'geral';
        let currentSearchTerm = '';
        
        // Dados est√°ticos de tokens (BASE)
        const BASE_TOKENS_CONFIG = [
            { ticker: 'AAVE',   name: 'Aave',              id: 'aave' },
            { ticker: 'AERO',   name: 'Aerodrome Finance', id: 'aerodrome-finance' },
            { ticker: 'AR',     name: 'Arweave',           id: 'arweave' },
            { ticker: 'ARB',    name: 'Arbitrum',          id: 'arbitrum' },
            { ticker: 'ATH',    name: 'Aethir',            id: 'aethir' },
            { ticker: 'ATOM',   name: 'Cosmos Hub',        id: 'cosmos' },
            { ticker: 'AVAX',   name: 'Avalanche',         id: 'avalanche-2' },
            { ticker: 'BTC',    name: 'Bitcoin',           id: 'bitcoin' },
            { ticker: 'CPOOL',  name: 'Clearpool',         id: 'clearpool' },
            { ticker: 'CFG',    name: 'Centrifuge',        id: 'centrifuge' },
            { ticker: 'DOT',    name: 'Polkadot',          id: 'polkadot' },
            { ticker: 'ETH',    name: 'Ethereum',          id: 'ethereum' },
            { ticker: 'ETHFI',  name: 'ether.fi',          id: 'ether-fi' },
            { ticker: 'EPIC',   name: 'Epic Chain',        id: 'epic-chain' },
            { ticker: 'GRIFFAIN', name: 'Griffain',        id: 'griffain' },
            { ticker: 'IMX',    name: 'Immutable',         id: 'immutable-x' },
            { ticker: 'IO',     name: 'io.net',            id: 'io-net' },
            { ticker: 'JUP',    name: 'Jupiter',           id: 'jupiter-exchange-solana' },
            { ticker: 'KAS',    name: 'Kaspa',             id: 'kaspa' },
            { ticker: 'LTC',    name: 'Litecoin',          id: 'litecoin' },
            { ticker: 'LDO',    name: 'Lido DAO',          id: 'lido-dao' },
            { ticker: 'METIS',  name: 'Metis',             id: 'metis-token' },
            { ticker: 'MORPHO', name: 'Morpho',            id: 'morpho' },
            { ticker: 'NEAR',   name: 'NEAR',              id: 'near' },
            { ticker: 'ONDO',   name: 'Ondo',              id: 'ondo-finance' },
            { ticker: 'PENDLE', name: 'Pendle',            id: 'pendle' },
            { ticker: 'POL',    name: 'Polygon',           id: 'polygon-ecosystem-token' },
            { ticker: 'PYTH',   name: 'Pyth Network',      id: 'pyth-network' },
            { ticker: 'QNT',    name: 'Quant',             id: 'quant-network' },
            { ticker: 'QUBIC',  name: 'Qubic',             id: 'qubic-network' },
            { ticker: 'RENDER', name: 'Render',            id: 'render-token' },
            { ticker: 'RIO',    name: 'Realio Network',    id: 'realio-network' },
            { ticker: 'RSR',    name: 'Reserve Rights',    id: 'reserve-rights-token' },
            { ticker: 'SEI',    name: 'Sei Network',       id: 'sei-network' },
            { ticker: 'SNX',    name: 'Synthetix',         id: 'synthetix-network-token' },
            { ticker: 'SPELL',  name: 'Spell',             id: 'spell-token' },
            { ticker: 'STX',    name: 'Stacks',            id: 'blockstack' },
            { ticker: 'SUI',    name: 'Sui',               id: 'sui' },
            { ticker: 'SYRUP',  name: 'Maple Finance',     id: 'maple' },
            { ticker: 'TAI',    name: 'Tars Protocol',     id: 'tars-protocol' },
            { ticker: 'TRU',    name: 'TrueFi',            id: 'truefi-token' },
            { ticker: 'VIRTUAL', name: 'Virtuals Protocol', id: 'virtual-protocol' },
            { ticker: 'VIRTUALS', name: 'Virtuals Protocol', id: 'virtual-protocol' },
            { ticker: 'ASTER',  name: 'Astar',             id: 'astar' },
            { ticker: 'XDC',    name: 'XDC Network',       id: 'xdce-crowd-sale' },
            { ticker: 'XTZ',    name: 'Tezos',             id: 'tezos' },
            { ticker: 'LINK',   name: 'Chainlink',         id: 'chainlink' }, 
            { ticker: 'FET',    name: 'Artificial Superintelligence Alliance', id: 'fetch-ai' },
            { ticker: 'BNB',    name: 'BNB',               id: 'binancecoin' },
            { ticker: 'XMR',    name: 'Monero',            id: 'monero' },
            { ticker: 'XLM',    name: 'Stellar',           id: 'stellar' },
            { ticker: 'HBAR',   name: 'Hedera',            id: 'hedera-hashgraph' },
            { ticker: 'UNI',    name: 'Uniswap',           id: 'uniswap' },
            { ticker: 'MNT',    name: 'Mantle',            id: 'mantle' },
            { ticker: 'TAO',    name: 'Bittensor',         id: 'bittensor' },
            { ticker: 'ICP',    name: 'Internet Computer', id: 'internet-computer' },
            { ticker: 'FIL',    name: 'Filecoin',          id: 'filecoin' },
            { ticker: 'GRT',    name: 'The Graph',         id: 'the-graph' },
            { ticker: 'APT',    name: 'Aptos',             id: 'aptos' },
            { ticker: 'ENA',    name: 'Ethena',            id: 'ethena' },
            { ticker: 'ALGO',   name: 'Algorand',          id: 'algorand' },
            { ticker: 'PUMP',   name: 'Pump.fun',          id: 'pump-fun' }, 
            { ticker: 'DASH',   name: 'Dash',              id: 'dash' },
            { ticker: 'STRK',   name: 'Starknet',          id: 'starknet' },
            { ticker: 'TIA',    name: 'Celestia',          id: 'celestia' },
            { ticker: 'KSM',    name: 'Kusama',            id: 'kusama' },
            { ticker: 'INJ',    name: 'Injective',         id: 'injective-protocol' },
            { ticker: 'MYX',    name: 'MYX Finance',       id: 'myx-finance' }, 
            { ticker: 'SAND',   name: 'The Sandbox',       id: 'the-sandbox' },
            { ticker: 'HNT',    name: 'Helium',            id: 'helium' },
            { ticker: 'ZK',     name: 'ZKsync',            id: 'zksync' }, 
            { ticker: 'ZRO',    name: 'LayerZero',         id: 'layerzero' }, 
            { ticker: 'DIA',    name: 'Dia',               id: 'dia-data' },
            { ticker: 'KMNO',   name: 'Kamino',            id: 'kamino' }, 
            { ticker: 'AKT',    name: 'Akash Network',     id: 'akash-network' },
            { ticker: 'PLUME',  name: 'Plume',             id: 'plume' }, 
            { ticker: 'AVNT',   name: 'Avantis',           id: 'avantis' }, 
            { ticker: 'KTA',    name: 'Keeta',             id: 'keeta' }, 
            { ticker: 'COOKIE', name: 'Cookie DAO',        id: 'cookie' }
        ];

        let USER_TOKENS_CONFIG = [];
        let ALL_TOKENS_CONFIG = [];

        // Contexto Wyckoff Est√°tico (Mantido)
        const STATIC_WYCKOFF_CONTEXT = {
            'BTC': 'Narrativa: **Layer 1 / Ouro Digital**. Contexto: O Bitcoin √© o ativo de reserva e define o tom do mercado. Sua fase atual √© de **Distribui√ß√£o Macro**, sugerindo que corre√ß√µes agressivas s√£o prov√°veis antes de novas m√°ximas. Acompanhe a for√ßa do d√≥lar.',
            'ETH': 'Narrativa: **Layer 1 / Smart Contracts**. Contexto: O Ethereum est√° em uma **Fase de Re-acumula√ß√£o (Fase B/C)**. A for√ßa das narrativas de Layer 2 e a transi√ß√£o para PoS suportam a tese de que grandes fundos continuam a absorver liquidez acima de suportes chave.',
            'KAS': 'Narrativa: **Layer 1 / PoW**. Contexto: Este ativo possui um forte momentum de Mark-up (Fase D/E). O comportamento agressivo de alta sugere exaust√£o pr√≥xima. **Risco:** Pullbacks s√£o violentos; a corre√ß√£o pode iniciar uma Distribui√ß√£o prolongada.',
            'IMX': 'Narrativa: **Layer 2 / Gaming**. Contexto: Forte candidato no setor de jogos. A estrutura atual indica uma **corre√ß√£o t√©cnica** em busca de zonas de demanda (Suporte). Isso se encaixa em uma Fase A/B de Acumula√ß√£o em um timeframe menor, buscando um ponto de partida.',
            'PENDLE': 'Narrativa: **DeFi / Yield**. Contexto: Ap√≥s um Mark-up explosivo, o PENDLE mostra sinais de **Distribui√ß√£o Institucional**. Se a perda de suportes cr√≠ticos for confirmada, o pre√ßo entrar√° em Redistribui√ß√£o ou Fase E de Distribui√ß√£o final.',
            'CFG': 'Narrativa: **RWA / DeFi**. Contexto: O ativo est√° em **Acumula√ß√£o de Fundo (Fase B/C)**. O baixo volume e a volatilidade contida sugerem que o Smart Money est√° posicionado e aguarda o catalisador. Riscos associados √† baixa liquidez.',
            'RIO': 'Narrativa: **RWA / Tokeniza√ß√£o**. Contexto: Estrutura em **Reacumula√ß√£o Especulativa**. Devido √† baixa liquidez e Market Cap, a a√ß√£o do pre√ßo √© mais vol√°til e menos previs√≠vel do que a Acumula√ß√£o Wyckoff Cl√°ssica.',
            'VIRTUAL': 'Narrativa: **Gaming / Metaverso**. Contexto: Ativo rec√©m-listado. Volatilidade extrema, alternando entre mini-fases de Distribui√ß√£o e Reacumula√ß√£o em curtos espa√ßos de tempo. N√£o √© recomendado para hold de longo prazo sem Stop Loss.',
            'GRIFFAIN': 'Narrativa: **Micro-Cap / Especulativo**. Contexto: Risco alt√≠ssimo. A assimetria extrema √© dependente de fluxo especulativo. As Fases Wyckoff (micro) s√£o sujeitas a manipula√ß√µes t√≠picas de micro-Wyckoff.',
            'LINK': 'Narrativa: **Or√°culos / Infraestrutura**. Contexto: Ativo de infraestrutura essencial. Est√° em um padr√£o claro de **Acumula√ß√£o/Reacumula√ß√£o** com fundos ascendentes. O mercado est√° absorvendo a oferta para um futuro rompimento (Mark-up).',
            'FET': 'Narrativa: **AI (Intelig√™ncia Artificial)**. Contexto: Uma das l√≠deres em AI. Sua estrutura √© de **Mark-up Estendido**. Procure sinais de exaust√£o (Distribui√ß√£o) ou use pullbacks para acumula√ß√£o em suportes relevantes.',
            'BNB': 'Narrativa: **Exchange / Layer 1**. Contexto: Ativo da Binance. Acompanha de perto o ciclo do BTC. Estrutura lateralizada que oscila entre Distribui√ß√£o e Reacumula√ß√£o de Topo. Risco de regula√ß√£o afeta o pre√ßo.',
            'XMR': 'Narrativa: **Privacidade / PoW**. Contexto: Ativo maduro, focado em privacidade. Sua longa **Acumula√ß√£o Lateral (Fase B)** sugere que uma grande movimenta√ß√£o (Mark-up) est√° sendo preparada (Causa -> Efeito).',
            'XLM': 'Narrativa: **Pagamentos / Layer 1**. Contexto: O ativo busca o fundo em um ciclo de **Acumula√ß√£o Prolongada**. O baixo volume e a lateralidade sugerem que a demanda √© fraca, necessitando de um evento de "Spring" (Fase C) para atrair liquidez.',
            'HBAR': 'Narrativa: **Governan√ßa / DLT**. Contexto: Forte foco institucional. Encontra-se nas **Fases Iniciais de Acumula√ß√£o**, onde o mercado est√° buscando liquidez. √â um bom ativo para DCA (Dollar-Cost Averaging) em zonas de demanda.',
            'UNI': 'Narrativa: **DeFi / DEX**. Contexto: Principal DEX do mercado. Est√° em **Mark-up (Fase D)**. Poss√≠vel Reacumula√ß√£o Intermedi√°ria. Enquanto mantiver suportes, a tend√™ncia √© de alta cont√≠nua.',
            'MNT': 'Narrativa: **Layer 2 / Ecossistema**. Contexto: Novo ativo de ecossistema. Estrutura de **Acumula√ß√£o** com potencial de rompimento ap√≥s absorver a oferta. Siga a liquidez do ecossistema.',
            'TAO': 'Narrativa: **AI / DePIN**. Contexto: Altamente especulativo devido √† narrativa de AI. Os ciclos Wyckoff s√£o **acelerados**. Requer an√°lise de volume em tempo real para identificar cl√≠max de compra/venda.',
            'ICP': 'Narrativa: **Cloud / Web3**. Contexto: Revers√£o recente de tend√™ncia. Est√° em **Reacumula√ß√£o**, testando os suportes para consolidar o movimento. Uma falha de suporte indica que a euforia inicial acabou.',
            'FIL': 'Narrativa: **Armazenamento / DePIN**. Contexto: Construindo um fundo ap√≥s uma forte tend√™ncia de baixa. Encontra-se na **Fase B/C de Acumula√ß√£o**, onde a volatidade deve ser comprimida antes do Mark-up.',
            'GRT': 'Narrativa: **Infraestrutura / Indexa√ß√£o**. Contexto: Essencial para o ecossistema. Est√° em **Mark-up**, mas se aproximando de uma zona de Distribui√ß√£o/Resist√™ncia. Cuidado com o SOT (Shift of Trend) de topo.',
            'APT': 'Narrativa: **Layer 1**. Contexto: Ciclo de **Acumula√ß√£o** ativo. Est√° pr√≥ximo a uma regi√£o de valor (Suporte). Aguarde por um sinal de "Spring" (Fase C) para entradas de maior risco/recompensa.',
            'ENA': 'Narrativa: **Stablecoin Sint√©tica / DeFi**. Contexto: Ativo muito novo e vol√°til. A estrutura sugere **mini-Distribui√ß√£o** no curto prazo. Risco de liquida√ß√£o alto devido √† natureza sint√©tica.',
            'ALGO': 'Narrativa: **Layer 1**. Contexto: Longa **Acumula√ß√£o** com compress√£o de volatilidade (coiling). √â um sinal cl√°ssico de que um movimento forte est√° pr√≥ximo, seja para cima ou para baixo.',
            'PUMP': 'Narrativa: **Memecoin / Solana**. Contexto: Extrema volatilidade e risco. Use o micro-Wyckoff. As fases s√£o muito r√°pidas e dependem puramente da euforia da comunidade e do fluxo de capital.',
            'DASH': 'Narrativa: **Pagamentos / Privacidade**. Contexto: **Acumula√ß√£o de Fundo (Fase B)**. Possui baixa atra√ß√£o de volume no momento. A espera √© por um catalisador (Fase C).',
            'STRK': 'Narrativa: **Layer 2 / ZK Rollup**. Contexto: P√≥s-lan√ßamento. Est√° em **Acumula√ß√£o**, com o mercado definindo o valor justo. Testando a demanda em n√≠veis baixos, o que √© comum para novos L2s.',
            'TIA': 'Narrativa: **Modularidade**. Contexto: Ativo forte em **Mark-up**. Est√° em **Realiza√ß√£o (Pullback)**. A busca √© por uma zona de Reacumula√ß√£o intermedi√°ria para a pr√≥xima perna de alta.',
            'KSM': 'Narrativa: **Ecossistema Polkadot**. Contexto: **Acumula√ß√£o (Fase B)**. O mercado est√° quieto. √â o momento de buscar liquidez antes de um Mark-up. Sinal de longo prazo.',
            'INJ': 'Narrativa: **DeFi / Layer 1**. Contexto: Forte tend√™ncia. Em **Pullback/Realiza√ß√£o**. A procura √© por uma zona de Reacumula√ß√£o para continuar o ciclo Mark-up.',
            'MYX': 'Narrativa: **DEX / Perp√©tuos**. Contexto: Ativo novo. Fases iniciais de teste de mercado. **Volatilidade de descoberta de pre√ßo**. N√£o h√° um padr√£o Wyckoff claro ainda.',
            'SAND': 'Narrativa: **Metaverso / Gaming**. Contexto: **Acumula√ß√£o Ampla**. O mercado est√° no processo de absorver a oferta. Um rompimento da faixa lateral indicar√° o in√≠cio de um novo Mark-up.',
            'HNT': 'Narrativa: **DePIN / IoT**. Contexto: **Mark-up estendido**. Sinais de que o ciclo de alta est√° maduro, entrando em zonas de Distribui√ß√£o. Cuidado com picos de volume que n√£o resultam em fechamentos altos.',
            'ZK': 'Narrativa: **Layer 2 / ZK Rollup**. Contexto: Novo ativo. Estrutura de **Acumula√ß√£o P√≥s-Lan√ßamento**. O mercado est√° definindo a base para o futuro.',
            'ZRO': 'Narrativa: **Infraestrutura / Interoperabilidade**. Contexto: Novo ativo. Volatilidade, testes iniciais de Oferta e Demanda. A fase inicial de Acumula√ß√£o deve ser vol√°til.',
            'DIA': 'Narrativa: **Or√°culos / Dados**. Contexto: **Acumula√ß√£o de Fundo** com compress√£o de volatilidade. A base de pre√ßo est√° sendo constru√≠da. Aguarda-se o rompimento.',
            'KMNO': 'Narrativa: **DeFi / Lending**. Contexto: Ativo muito novo. **Testes iniciais de Demanda**. Risco alto at√© que um hist√≥rico de pre√ßos se estabele√ßa.',
            'AKT': 'Narrativa: **DePIN / Nuvem Descentralizada**. Contexto: **Mark-up forte**. Est√° buscando Resist√™ncias hist√≥ricas, indicando um poss√≠vel in√≠cio de Distribui√ß√£o. Mantenha cautela.',
            'PLUME': 'Narrativa: **RWA / Layer 2**. Contexto: Ativo novo. **Acumula√ß√£o** em andamento, com pouco hist√≥rico. Volatilidade esperada.',
            'AVNT': 'Narrativa: **Derivativos / Exchange**. Contexto: Ativo novo. Fases iniciais vol√°teis de **Teste de Oferta e Demanda**.',
            'KTA': 'Narrativa: **Gaming / Web3**. Contexto: Ativo novo. **Alta Volatilidade**. Aguarda-se a defini√ß√£o de um range de acumula√ß√£o.',
            'COOKIE': 'Narrativa: **Web3 / Marketing**. Contexto: Ativo novo. **Fases iniciais de Teste** de Mercado. Baixa liquidez e alta sensibilidade a fluxos de capital.'
        };

        // --- FUN√á√ïES DE C√ÅLCULO E FORMATA√á√ÉO (Mantidas) ---

        function calculateRSIHeuristic(change24h, change7d) {
            if (isNaN(change24h) || isNaN(change7d)) {
                return { text: 'N/D', class: '', value: 50 };
            }
            let rsi = 50 + (change24h * 1.5) + (change7d * 0.2);
            rsi = Math.min(100, Math.max(0, rsi));
            let className = '';
            if (rsi >= 70) className = 'rsi-high';
            else if (rsi <= 30) className = 'rsi-low';
            return { text: rsi.toFixed(0), class: className, value: rsi };
        }

        function calculateSRProximity(price, rangeLow, rangeHigh) {
            if (!price || !rangeLow || !rangeHigh || price === 0 || rangeLow === 0) return { text: 'N/D', class: 'neutral', value: 0 };
            
            const range = rangeHigh - rangeLow;
            if (range <= 0) return { text: 'Lateralizado', class: 'neutral', value: 0.5 };

            const proximityFactor = 0.40; 

            const distToLow = price - rangeLow;
            const distToHigh = rangeHigh - price;

            if (price > rangeHigh) return { text: 'Cl√≠max/TOPO', class: 'sr-resistance', value: 1 };
            if (price < rangeLow) return { text: 'Cl√≠max/FUNDO', class: 'sr-support', value: 0 };


            if (distToLow / range < proximityFactor) {
                return { text: 'Pr√≥x. Suporte', class: 'sr-support', value: (distToLow / range) };
            }
            if (distToHigh / range < proximityFactor) {
                return { text: 'Pr√≥x. Resist.', class: 'sr-resistance', value: (distToHigh / range) };
            }

            return { text: 'Meio de Range', class: 'neutral', value: 0.5 };
        }

        function determineWyckoffDynamic(change7d, change30d, marketCap, rsiValue) {
            if (isNaN(change7d) || isNaN(change30d) || isNaN(marketCap) || isNaN(rsiValue)) {
                return { text: 'Fase indefinida', class: '', phase: 'neutro' };
            }
            const marketCapThreshold = 500000000;
            const accThreshold = (marketCap < marketCapThreshold) ? 10 : 5;
            const distThreshold = (marketCap < marketCapThreshold) ? -10 : -5;

            if (rsiValue <= 35 && change30d < -20) {
                return { text: 'Fase C (Spring/Testes de fundo)', class: '', phase: 'acc' };
            }
            if (rsiValue >= 70 && change30d > 25) {
                return { text: 'Fase E (Cl√≠max/Distribui√ß√£o final)', class: '', phase: 'dist' };
            }
            if (change7d < distThreshold && change30d < -15) {
                return { text: 'Fase D/E (Distribui√ß√£o)', class: '', phase: 'dist' };
            }
            if (change7d > accThreshold && change30d > 10) {
                return { text: 'Fase D (Markup/Acumula√ß√£o tardia)', class: '', phase: 'acc' };
            }
            return { text: 'Fase B (Lateraliza√ß√£o/Neutro)', class: '', phase: 'neutro' };
        }

        function calculateAttractionScore(athDropPct, rsiValue, wyckoffPhase, erScore) {
            if (athDropPct === null || isNaN(rsiValue)) return null;
            let score = 0;

            if (athDropPct <= -70) score += 40;
            else if (athDropPct <= -50) score += 30;
            else if (athDropPct <= -30) score += 20;
            else if (athDropPct <= -15) score += 10;

            if (rsiValue <= 25) score += 30;
            else if (rsiValue <= 35) score += 20;
            else if (rsiValue <= 45) score += 10;
            else if (rsiValue <= 60) score += 5;

            if (wyckoffPhase === 'acc') score += 20;
            else if (wyckoffPhase === 'neutro') score += 5;
            else if (wyckoffPhase === 'dist') score -= 20;

            if (!isNaN(erScore)) {
                if (erScore <= 30) score += 10;
                else if (erScore >= 70) score -= 10;
            }

            return Math.min(100, Math.max(0, score));
        }

        function calculateVsBtcPerformance(altChange, btcChange) {
            if (altChange === null || btcChange === null || isNaN(altChange) || isNaN(btcChange)) {
                return { text: 'N/D', class: 'neutral', value: 0 };
            }
            
            const diff = altChange - btcChange;
            const sign = diff > 0 ? '+' : '';
            const className = diff > 0 ? 'positive' : diff < 0 ? 'negative' : 'neutral';

            return { text: sign + diff.toFixed(2) + '%', class: className, value: diff };
        }

        function generateDynamicWyckoffSignal(item) {
            const change7d = item.price_change_percentage_7d_in_currency;
            const change30d = item.price_change_percentage_30d_in_currency;
            const marketCap = item.market_cap;

            const rsiHeuristic = calculateRSIHeuristic(
                item.price_change_percentage_24h_in_currency,
                change7d
            );
            const rsiValue = parseFloat(rsiHeuristic.text === 'N/D' ? '50' : rsiHeuristic.text);
            const wyckoffDynamic = determineWyckoffDynamic(change7d, change30d, marketCap, rsiValue);

            return {
                text: wyckoffDynamic.text,
                class: wyckoffDynamic.class,
                phase: wyckoffDynamic.phase,
                rsiHeuristic
            };
        }

        function estimateFutureRange(currentPrice, change7d, change30d) {
            if (!currentPrice || isNaN(currentPrice)) {
                return {
                    weekLow: null, weekHigh: null
                };
            }
            const vol7 = Math.abs(change7d || 0) / 100;

            const weekLow = currentPrice * (1 - (vol7 || 0.08));
            const weekHigh = currentPrice * (1 + (vol7 || 0.08));

            return { weekLow, weekHigh };
        }

        function formatPrice(value) {
            if (value === null || value === undefined || isNaN(value)) return 'N/D';
            if (value >= 1) return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            if (value >= 0.01) return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 4, maximumFractionDigits: 4 });
            return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 6, maximumFractionDigits: 6 });
        }
        
        function formatDollarValue(value) {
            if (value === null || value === undefined || isNaN(value)) return 'N/D';
            const sign = value >= 0 ? '+' : '-';
            const absValue = Math.abs(value);

            if (absValue >= 1e9) return sign + '$' + (absValue / 1e9).toFixed(2) + 'B';
            if (absValue >= 1e6) return sign + '$' + (absValue / 1e6).toFixed(2) + 'M';
            if (absValue >= 1000) return sign + '$' + absValue.toLocaleString('en-US', { maximumFractionDigits: 0 });
            
            // Para valores menores que 1000 USD, exibe mais casas decimais para USD
            if (absValue >= 1) return sign + '$' + absValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            return sign + '$' + absValue.toLocaleString('en-US', { minimumFractionDigits: 4, maximumFractionDigits: 4 });
        }

        function formatPercent(value) {
            if (value === null || value === undefined || isNaN(value)) return 'N/D';
            const sign = value > 0 ? '+' : '';
            return sign + value.toFixed(2) + '%';
        }

        function formatTokenCount(value) {
            if (value === null || value === undefined || isNaN(value)) return 'N/D';
            if (value >= 1e9) return (value / 1e9).toFixed(2) + 'B';
            if (value >= 1e6) return (value / 1e6).toFixed(2) + 'M';
            if (value >= 1) return value.toLocaleString('en-US', { maximumFractionDigits: 2 });
            return value.toLocaleString('en-US', { minimumFractionDigits: 6, maximumFractionDigits: 6 });
        }

        function getTradingViewSymbol(ticker) {
            const baseTicker = ticker.toUpperCase();
            const preferredExchanges = {
                'BTC': 'BINANCE', 'ETH': 'BINANCE', 'KAS': 'MEXC', 'IMX': 'BINANCE', 'PENDLE': 'BINANCE',
                'SEI': 'BINANCE', 'SUI': 'BINANCE', 'STX': 'BINANCE', 'NEAR': 'BINANCE', 'RENDER': 'BINANCE',
                'ETHFI': 'BINANCE', 'VIRTUAL': 'GATEIO', 'TRU': 'BINANCE', 'CPOOL': 'KUCOIN', 'RIO': 'KUCOIN',
                'CFG': 'GATEIO', 'TAI': 'GATEIO', 'GRIFFAIN': 'MEXC', 'AAVE': 'BINANCE', 'ATOM': 'BINANCE',
                'AVAX': 'BINANCE', 'LTC': 'BINANCE', 'LDO': 'BINANCE', 'ONDO': 'BINANCE', 'PYTH': 'BINANCE',
                'SNX': 'BINANCE', 'QNT': 'BINANCE', 'RSR': 'BINANCE', 'QUBIC': 'MEXC', 'EPIC': 'MEXC',
                'POL': 'BINANCE', 'XDC': 'KUCOIN', 'METIS': 'BINANCE', 'IO': 'BINANCE', 'JUP': 'BINANCE',
                'MORPHO': 'BINANCE', 'ASTER': 'GATEIO', 'SYRUP': 'BINANCE', 'XTZ': 'BINANCE',
                'LINK': 'BINANCE', 'FET': 'BINANCE', 'BNB': 'BINANCE', 'XMR': 'BINANCE', 'XLM': 'BINANCE', 'HBAR': 'BINANCE',
                'UNI': 'BINANCE', 'MNT': 'BINANCE', 'TAO': 'BINANCE', 'ICP': 'BINANCE', 'FIL': 'BINANCE',
                'GRT': 'BINANCE', 'APT': 'BINANCE', 'ENA': 'BINANCE', 'ALGO': 'BINANCE', 'PUMP': 'GATEIO',
                'DASH': 'BINANCE', 'STRK': 'BINANCE', 'TIA': 'BINANCE', 'KSM': 'BINANCE', 'INJ': 'BINANCE',
                'MYX': 'GATEIO', 'SAND': 'BINANCE', 'HNT': 'BINANCE', 'ZK': 'BINANCE', 'ZRO': 'BINANCE',
                'DIA': 'BINANCE', 'KMNO': 'BYBIT', 'AKT': 'KUCOIN', 'PLUME': 'GATEIO', 'AVNT': 'GATEIO',
                'KTA': 'MEXC', 'COOKIE': 'GATEIO',
                'SOL': 'BINANCE', 'DOT': 'BINANCE', 'SHIB': 'BINANCE' 
            };
            const exchange = preferredExchanges[baseTicker] || 'BINANCE';
            return `${exchange}:${baseTicker}USDT`;
        }

        function showToast(message, duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            container.appendChild(toast);

            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 200);
            }, duration);
        }

        const tooltipOverlay = document.getElementById('metric-tooltip-overlay');
        const tooltipTitle = document.getElementById('metric-tooltip-title');
        const tooltipBody = document.getElementById('metric-tooltip-body');
        const tooltipCloseBtn = document.getElementById('metric-tooltip-close');

        function openMetricTooltip(title, bodyText) {
            tooltipTitle.textContent = title;
            tooltipBody.innerHTML = bodyText;
            tooltipOverlay.classList.add('active');
        }

        function closeMetricTooltip() {
            tooltipOverlay.classList.remove('active');
        }

        tooltipCloseBtn.addEventListener('click', closeMetricTooltip);
        tooltipOverlay.addEventListener('click', (e) => {
            if (e.target === tooltipOverlay) closeMetricTooltip();
        });

        // Fun√ß√£o de Atraso para Backoff
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // --- GEST√ÉO DE TOKENS DO USU√ÅRIO ---

        function loadUserTokens() {
            const storedTokens = localStorage.getItem(USER_TOKENS_STORAGE_KEY);
            try {
                USER_TOKENS_CONFIG = storedTokens ? JSON.parse(storedTokens) : [];
            } catch {
                USER_TOKENS_CONFIG = [];
            }
            const uniqueTokens = [...BASE_TOKENS_CONFIG, ...USER_TOKENS_CONFIG]
                .filter((token, index, self) => 
                    index === self.findIndex((t) => (
                        t.id === token.id
                    ))
                );
            ALL_TOKENS_CONFIG = uniqueTokens;
        }

        function saveUserTokens() {
            localStorage.setItem(USER_TOKENS_STORAGE_KEY, JSON.stringify(USER_TOKENS_CONFIG));
        }

        function addToken(ticker, name, id) {
            const token = { ticker: ticker.toUpperCase(), name, id };
            if (ALL_TOKENS_CONFIG.find(t => t.id === id)) {
                showToast(`O token ${ticker.toUpperCase()} j√° est√° na sua lista.`, 2000);
                return;
            }
            USER_TOKENS_CONFIG.push(token);
            saveUserTokens();
            loadUserTokens(); 
            renderActiveTokensList();
            showToast(`Token ${ticker.toUpperCase()} adicionado! Atualizando dados...`, 2500);
            fetchMarketData(); 
        }

        function removeToken(id, isUserToken = true) {
            if (isUserToken) {
                const tokenIndex = USER_TOKENS_CONFIG.findIndex(t => t.id === id);
                if (tokenIndex !== -1) {
                    const tokenTicker = USER_TOKENS_CONFIG[tokenIndex].ticker;
                    
                    // Remove do hist√≥rico de trades e alertas (opcional, mas recomendado)
                    delete tradeHistory[tokenTicker];
                    delete activeAlerts[tokenTicker];
                    saveTradesToStorage();
                    saveAlertsToStorage();

                    USER_TOKENS_CONFIG.splice(tokenIndex, 1);
                    saveUserTokens();
                    loadUserTokens(); 
                    renderActiveTokensList();
                    showToast(`Token ${tokenTicker} removido com sucesso.`, 2000);
                    renderAll(); 
                    return true;
                }
            }
            return false;
        }

        function renderActiveTokensList() {
            const userTickers = USER_TOKENS_CONFIG.map(t => {
                return `<span style="cursor:pointer; font-weight:600; color:var(--negative);" onclick="openConfirmModal('${t.id}', '${t.ticker}', true)">${t.ticker}</span>`;
            }).join(', ');
            
            ACTIVE_TOKENS_LIST_EL.innerHTML = userTickers.length > 0 ? userTickers : 'Nenhum token adicionado pelo usu√°rio.';
        }

        // --- GEST√ÉO DE TRADES E ALERTAS ---

        function loadDataFromStorage() {
            loadUserTokens(); 
            const storedAlerts = localStorage.getItem('wyckoff_alerts_v3');
            const storedTrades = localStorage.getItem(USER_TRADES_STORAGE_KEY);
            try {
                activeAlerts = storedAlerts ? JSON.parse(storedAlerts) : {};
                tradeHistory = storedTrades ? JSON.parse(storedTrades) : {};
            } catch {
                activeAlerts = {};
                tradeHistory = {};
            }
        }

        function saveAlertsToStorage() {
            localStorage.setItem('wyckoff_alerts_v3', JSON.stringify(activeAlerts));
        }

        function saveTradesToStorage() {
            localStorage.setItem(USER_TRADES_STORAGE_KEY, JSON.stringify(tradeHistory));
        }

        function registerTrade(ticker, type, price, quantity, totalValue, currentPrice) {
            const id = Date.now().toString();
            if (!tradeHistory[ticker]) tradeHistory[ticker] = [];

            // Apenas registra como "COMPRA"
            if (type === 'buy') {
                tradeHistory[ticker].push({
                    id,
                    ticker: ticker.toUpperCase(),
                    type: 'BUY',
                    price: parseFloat(price),
                    quantity: parseFloat(quantity),
                    totalValue: parseFloat(totalValue),
                    date: new Date().toISOString(),
                    closed: false
                });
                showToast(`Compra simulada de ${formatTokenCount(quantity)} ${ticker} registrada.`, 3000);
            } 
            // Fecha a √∫ltima posi√ß√£o de "COMPRA" aberta
            else if (type === 'sell') {
                const openBuyIndex = tradeHistory[ticker].findIndex(t => t.type === 'BUY' && !t.closed);
                if (openBuyIndex === -1) {
                    showToast(`Erro: N√£o h√° posi√ß√£o de COMPRA aberta para ${ticker} para fechar.`, 4000);
                    return;
                }

                const buyTrade = tradeHistory[ticker][openBuyIndex];
                
                // Calcula o P&L
                const initialValue = buyTrade.totalValue;
                const soldQuantity = quantity; // A venda usa a quantidade informada
                
                // Se o usu√°rio vender uma quantidade que exceda o que foi comprado, usamos o total comprado
                if (soldQuantity > buyTrade.quantity) {
                    showToast(`Aten√ß√£o: A quantidade vendida (${formatTokenCount(soldQuantity)}) excedeu a comprada (${formatTokenCount(buyTrade.quantity)}). Usando a quantidade comprada como base para o c√°lculo.`, 5000);
                    // Regra de simplifica√ß√£o: Fechamos toda a posi√ß√£o
                    const profitLossPrice = (currentPrice - buyTrade.price) * buyTrade.quantity;
                    const profitLossPct = (profitLossPrice / initialValue) * 100;
                    
                    buyTrade.closed = true;
                    buyTrade.sellPrice = currentPrice;
                    buyTrade.soldQuantity = buyTrade.quantity;
                    buyTrade.sellTotalValue = currentPrice * buyTrade.quantity;
                    buyTrade.profitLossPct = profitLossPct;
                    buyTrade.profitLossPrice = profitLossPrice;
                    
                } else {
                    // C√ÅLCULO PARCIAL (Se a quantidade vendida for menor ou igual √† comprada)
                    const profitLossPrice = (currentPrice - buyTrade.price) * soldQuantity;
                    const profitLossPct = (profitLossPrice / (buyTrade.price * soldQuantity)) * 100;
                    
                    // Adiciona um novo registro de venda para controle
                    tradeHistory[ticker].push({
                        id: Date.now().toString(),
                        ticker: ticker.toUpperCase(),
                        type: 'SELL',
                        price: currentPrice,
                        quantity: soldQuantity,
                        totalValue: currentPrice * soldQuantity,
                        date: new Date().toISOString(),
                        closed: true, // Vendas s√£o sempre fechadas (s√£o a realiza√ß√£o)
                        profitLossPct: profitLossPct,
                        profitLossPrice: profitLossPrice
                    });
                    
                    // Atualiza a posi√ß√£o de compra original se for uma venda parcial
                    buyTrade.quantity -= soldQuantity;
                    buyTrade.totalValue = buyTrade.quantity * buyTrade.price; // Recalcula o valor restante
                    
                    if (buyTrade.quantity <= 0.0000001) { // Garante que a posi√ß√£o √© fechada se for totalmente vendida
                        buyTrade.closed = true;
                        buyTrade.quantity = 0;
                        buyTrade.totalValue = 0;
                    }
                }
                
                const action = buyTrade.profitLossPct >= 0 ? 'Lucro' : 'Preju√≠zo';
                showToast(`‚úÖ ${action} de ${formatPercent(buyTrade.profitLossPct)} registrado para ${ticker}`, 4000);
            }
            
            saveTradesToStorage();
            renderCardTrades(ticker);
        }

        function renderCardAlerts(ticker) {
            const container = document.querySelector(`.card[data-ticker="${ticker}"] .active-alerts-list`);
            if (!container) return;

            const alerts = activeAlerts[ticker] ? Object.values(activeAlerts[ticker]) : [];
            if (alerts.length === 0) {
                container.innerHTML = '<p style="margin:0; font-size:0.7rem;">Nenhum alerta de pre√ßo ativo.</p>';
                return;
            }

            let html = '<p style="margin:0 0 4px; font-weight:600; color:var(--text-main);">Alertas ativos:</p>';
            alerts.forEach(a => {
                html += `
                    <div class="alert-item">
                        <span>
                            ${a.type === 'buy' ? 'COMPRA' : 'VENDA'} @ ${formatPrice(a.price)}
                            ${a.triggered ? '<span style="color:#f59e0b;font-weight:600;"> (ATINGIDO)</span>' : ''}
                        </span>
                        <button class="remove-btn" onclick="(function(){ removeAlert('${ticker}', '${a.id}'); })()">remover</button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function renderCardTrades(ticker) {
            const container = document.querySelector(`.card[data-ticker="${ticker}"] .trade-history-list`);
            const itemData = allCryptoData.find(c => c.ticker === ticker);
            const currentPrice = itemData ? itemData.current_price : null;

            if (!container) return;

            const trades = tradeHistory[ticker] || [];
            if (trades.length === 0) {
                container.innerHTML = '<p style="margin:0; font-size:0.7rem;">Nenhum hist√≥rico de trade simulado.</p>';
                return;
            }

            let html = '<p style="margin:0 0 4px; font-weight:600; color:var(--text-main);">Hist√≥rico de trades (Simula√ß√£o):</p>';
            
            // Exibe a posi√ß√£o em aberto no topo, se houver
            const openBuyTrade = trades.find(t => t.type === 'BUY' && !t.closed);
            if (openBuyTrade && currentPrice) {
                const currentPnlPrice = (currentPrice - openBuyTrade.price) * openBuyTrade.quantity;
                const currentPnlPct = (currentPnlPrice / openBuyTrade.totalValue) * 100;
                const statusClass = currentPnlPct >= 0 ? 'val-positive' : 'val-negative';
                
                html += `
                    <div class="history-item" style="background: var(--accent-soft); padding: 5px; border-radius: 4px; margin-bottom: 5px;">
                        <span>
                            **POSI√á√ÉO ABERTA** (${formatTokenCount(openBuyTrade.quantity)} ${openBuyTrade.ticker})
                            <br>Compra @ ${formatPrice(openBuyTrade.price)}
                        </span>
                        <span class="history-pnl ${statusClass}">
                            ${formatPercent(currentPnlPct)}
                            <br>${formatDollarValue(currentPnlPrice)}
                        </span>
                    </div>
                `;
            }

            // Exibe os √∫ltimos trades (compras e vendas fechadas)
            const closedTrades = trades.filter(t => t.closed).slice(-5).reverse();
            
            closedTrades.forEach(t => { 
                let pnlDisplay = '';
                let statusClass = '';

                if (t.type === 'BUY') { // Venda/fechamento com c√°lculo de P&L
                    statusClass = t.profitLossPct >= 0 ? 'val-positive' : 'val-negative';
                    pnlDisplay = `<span class="history-pnl ${statusClass}"> 
                                    ${formatPercent(t.profitLossPct)}
                                    <br>${formatDollarValue(t.profitLossPrice)}
                                  </span>`;
                
                    html += `
                        <div class="history-item">
                            <span>
                                FECHOU POS. (${formatTokenCount(t.soldQuantity)})
                                <br>Comprada @ ${formatPrice(t.price)}
                            </span>
                            ${pnlDisplay}
                        </div>
                    `;
                } else if (t.type === 'SELL') { // Registro de Venda Parcial
                     statusClass = t.profitLossPct >= 0 ? 'val-positive' : 'val-negative';
                     pnlDisplay = `<span class="history-pnl ${statusClass}">
                                    ${formatPercent(t.profitLossPct)}
                                    <br>${formatDollarValue(t.profitLossPrice)}
                                  </span>`;
                     html += `
                        <div class="history-item">
                            <span>
                                VENDIDO PARCIAL (${formatTokenCount(t.quantity)})
                                <br>@ ${formatPrice(t.price)}
                            </span>
                            ${pnlDisplay}
                        </div>
                    `;
                }
            });
            container.innerHTML += `<p style="margin:0 0 4px; font-weight:600; color:var(--text-main); margin-top: 10px;">√öltimas Transa√ß√µes:</p>`;
            container.innerHTML += html;
        }

        // --- FUN√á√ÉO DE INTERPRETA√á√ÉO E TOOLTIP (REVISADA E DID√ÅTICA) ---

        function getAnalyticalInterpretation(label, value, item, isValue) {
            const ticker = item.ticker;
            
            // Tenta obter o contexto est√°tico para o token, sen√£o usa um padr√£o
            const fullContext = STATIC_WYCKOFF_CONTEXT[ticker] || 'Narrativa: **Sem narrativa espec√≠fica**. Contexto: Ativo dinamicamente adicionado. Nenhuma an√°lise Wyckoff est√°tica dispon√≠vel. Use a an√°lise din√¢mica.';
            const match = fullContext.match(/Narrativa:\s*\*\*(.*?)\*\*/);
            const narrative = match ? match[1].trim() : 'Geral (Adicionado Dinamicamente)';
            
            if (isValue) {
                switch (label) {
                    case 'Pre√ßo atual':
                        return `**M√©trica:** Pre√ßo de negocia√ß√£o mais recente: **${formatPrice(item.current_price)}**. Este √© o valor que o mercado atribui ao ativo neste instante.
                        <br><br>**An√°lise:** O pre√ßo atual √© a base para todos os c√°lculos de Risco e Recompensa. √â o ponto de refer√™ncia para definir seus pontos de entrada (Suporte) e sa√≠da/realiza√ß√£o de lucros (Resist√™ncia).`;
                    
                    case 'Varia√ß√£o 1h':
                        const c1h = item.price_change_percentage_1h_in_currency;
                        return `**M√©trica:** Varia√ß√£o de ${formatPercent(c1h)} na √∫ltima hora.
                        <br><br>**An√°lise:** Este √© o **Momentum Imediato**. Ele indica a euforia ou p√¢nico em tempo real. Uma varia√ß√£o forte (>5%) em 1h √© um sinal de **extrema volatilidade** e sugere que a movimenta√ß√£o pode ser insustent√°vel sem um catalisador forte. √â √∫til para scalping, mas perigoso para estrat√©gias de longo prazo.`;

                    case 'Varia√ß√£o 24h':
                        const c24h = item.price_change_percentage_24h_in_currency;
                        return `**M√©trica:** Varia√ß√£o de ${formatPercent(c24h)} nas √∫ltimas 24 horas.
                        <br><br>**An√°lise:** Este √© o **Momentum Di√°rio**. Varia√ß√µes significativas (como +10% ou -10%) indicam **euforia ou p√¢nico** intenso. Se for um *pullback* (queda) e o pre√ßo estiver pr√≥ximo a um Suporte chave, pode sinalizar uma oportunidade de compra. Se for uma alta (euforia) pr√≥xima a uma Resist√™ncia, sugere cautela.`;

                    case 'Varia√ß√£o 7D':
                        const c7d = item.price_change_percentage_7d_in_currency;
                        return `**M√©trica:** Varia√ß√£o de ${formatPercent(c7d)} na √∫ltima semana.
                        <br><br>**An√°lise:** Define a **Tend√™ncia de Curto Prazo**. Uma varia√ß√£o positiva forte e sustentada (>15%) √© t√≠pica de uma fase de *Mark-up* (alta) de Wyckoff. Uma queda cont√≠nua sugere que o ativo pode estar em fase de Distribui√ß√£o ou Reacumula√ß√£o de Fundo.`;

                    case 'Varia√ß√£o 30D':
                        const c30d = item.price_change_percentage_30d_in_currency;
                        return `**M√©trica:** Varia√ß√£o de ${formatPercent(c30d)} no √∫ltimo m√™s.
                        <br><br>**An√°lise:** Este √© o **Indicador Macro**. √â crucial para determinar a fase principal de Wyckoff. Ganhos acima de 30% em 30 dias sugerem que o ativo est√° maduro para Distribui√ß√£o (realiza√ß√£o de lucros). Quedas profundas s√£o a base para uma futura Acumula√ß√£o.`;
                    
                    case 'Alpha vs. BTC (1h)':
                    case 'Alpha vs. BTC (7D)':
                    case 'Alpha vs. BTC (30D)':
                        let period = label.match(/\((.*?)\)/)[1];
                        let alphaAnalysis;
                        if (value > 0.5) {
                            alphaAnalysis = `O ativo **superou o Bitcoin** em **${formatPercent(value)}** neste per√≠odo. **A conclus√£o √© de For√ßa Relativa (ALPHA)**. Isso significa que o dinheiro est√° saindo do BTC e entrando neste ativo.`;
                        } else if (value < -0.5) {
                            alphaAnalysis = `O ativo **perdeu valor contra o Bitcoin** em **${formatPercent(value)}** neste per√≠odo. **A conclus√£o √© de Fraqueza Relativa (BETA)**. Indica que h√° uma press√£o vendedora espec√≠fica ou que os investidores est√£o retornando ao BTC.`;
                        } else {
                            alphaAnalysis = `O desempenho est√° em linha com o Bitcoin. **A conclus√£o √© Neutra**.`;
                        }
                        return `**M√©trica:** Mede o desempenho do ativo comparado ao Bitcoin (${period}).
                        <br><br>**An√°lise:** O Alpha √© o indicador da migra√ß√£o de capital. **Alpha positivo √© sempre um sinal de BULLISH para Altcoins**, pois mostra que o ativo √© mais forte que a refer√™ncia do mercado. Utilize o Alpha para decidir quais Altcoins comprar ap√≥s uma corre√ß√£o do BTC.`;

                    case 'Proximidade S/R (Heur√≠stica)':
                        const srText = item.sr_proximity.text;
                        const srClass = item.sr_proximity.class;
                        
                        if (srClass === 'sr-support') {
                            return `**M√©trica:** O pre√ßo est√° na **Zona de Suporte**, indicando que est√° pr√≥ximo ao fundo do range semanal.
                            <br><br>**An√°lise & Decis√£o:** **ALTO POTENCIAL DE COMPRA**. Esta √© a melhor zona para entrar, pois o risco (medido pelo Stop Loss) √© baixo, e o potencial de retorno (at√© a Resist√™ncia) √© alto. O Suporte atrai compradores institucionais.`;
                        } else if (srClass === 'sr-resistance') {
                            return `**M√©trica:** O pre√ßo est√° na **Zona de Resist√™ncia**, indicando que est√° pr√≥ximo ao topo do range semanal.
                            <br><br>**An√°lise & Decis√£o:** **RISCO DE REALIZA√á√ÉO DE LUCROS**. Esta √© uma zona onde os vendedores tendem a aparecer. √â o momento ideal para realizar lucros ou reduzir a exposi√ß√£o. Evite novas compras aqui.`;
                        }
                        return `**M√©trica:** O pre√ßo est√° no **Meio do Range** (distante de S/R).
                        <br><br>**An√°lise & Decis√£o:** **NEUTRO/AGUARDAR**. O risco/recompensa n√£o √© favor√°vel. Tentar operar no meio do range √© arriscado. Espere o pre√ßo se aproximar de um Suporte para comprar ou de uma Resist√™ncia para vender/realizar.`;

                    case 'RSI heur√≠stico (for√ßa relativa aproximada)':
                        const rsi = item.rsi_heuristic.text;
                        let rsiAnalysis;
                        if (parseFloat(rsi) >= 70) { rsiAnalysis = `O RSI em **${rsi}** indica **SOBRE-COMPRA** (ativo muito caro). **DECIS√ÉO: Venda/Realize Lucros**. O risco de corre√ß√£o √© iminente.`; } 
                        else if (parseFloat(rsi) <= 30) { rsiAnalysis = `O RSI em **${rsi}** indica **SOBRE-VENDA** (ativo muito barato). **DECIS√ÉO: Procure entradas**. O ativo est√° tecnicamente descontado e a revers√£o de tend√™ncia pode estar pr√≥xima.`; } 
                        else { rsiAnalysis = `O RSI em **${rsi}** indica **NEUTRALIDADE**.`; }
                        return `**M√©trica:** √çndice de For√ßa Relativa (RSI) aproximado: **${rsi}**. Ele mede a velocidade e a mudan√ßa dos movimentos de pre√ßo.
                        <br><br>**An√°lise:** O RSI √© um indicador de **Exaust√£o**. Valores altos (acima de 70) sugerem que o ativo subiu muito rapidamente e est√° *sobre-comprado*. Valores baixos (abaixo de 30) sugerem que o ativo caiu muito rapidamente e est√° *sobre-vendido*. √â um sinal forte para procurar revers√µes.`;
                        
                    case 'Score de atra√ß√£o':
                        const score = item.attraction_score;
                        let scoreAnalysis;
                        if (score >= 70) { scoreAnalysis = `O Score **${score.toFixed(0)}** indica **ALTA ASSIMETRIA**. √â o momento ideal para **acumula√ß√£o**, pois o risco √© baixo e o potencial de recompensa √© alto (bom desconto do ATH + fase de acumula√ß√£o).`; }
                        else if (score <= 40) { scoreAnalysis = `O Score **${score.toFixed(0)}** indica **BAIXA ASSIMETRIA**. **DECIS√ÉO: Evite Novas Entradas**. O ativo est√° caro, o risco √© alto e o potencial de retorno √© limitado.`; }
                        else { scoreAnalysis = `O Score **${score.toFixed(0)}** √© **MODERADO**. Siga os sinais de S/R e Alpha.`; }
                        return `**M√©trica:** Score Consolidado (0-100) que avalia a atratividade do ativo para compra. √â baseado em 4 fatores: Desconto do ATH, RSI, Fase Wyckoff e Proximidade S/R.
                        <br><br>**An√°lise:** Este √© o indicador de **Risco-Recompensa**. Ele agrega as m√©tricas essenciais. Um score alto sugere que o ativo est√° no melhor ponto de pre√ßo para acumular (baixo risco, alto potencial).`;

                    case 'Sinal Wyckoff (din√¢mico)':
                        return `**M√©trica:** Fase Wyckoff atual: ${item.wyckoff_dynamic.text}. (Narrativa: ${narrative}).
                        <br><br>**An√°lise & Decis√£o:** A metodologia Wyckoff mapeia o ciclo de mercado. **Acumula√ß√£o** (Fases A, B, C) significa que grandes investidores est√£o comprando (oportunidade). **Distribui√ß√£o** (Fases D, E) significa que eles est√£o vendendo (cautela/sa√≠da). Alinhe sua estrat√©gia (COMPRA/VENDA) com a fase atual para operar a favor do dinheiro inteligente.`;

                    default:
                        return `**Interpreta√ß√£o Anal√≠tica:** N√£o h√° uma an√°lise espec√≠fica definida para o valor ${value} de ${label}. Clique no r√≥tulo (lado esquerdo) para ver o conceito.`;
                }
            }

            // Defini√ß√µes Conceituais para o lado esquerdo (Label)
            switch (label) {
                case 'Pre√ßo atual':
                    return '**Conceito:** √â o pre√ßo mais recente pelo qual o ativo foi negociado. √â o ponto de partida de toda a sua an√°lise.';
                case 'Varia√ß√£o 1h':
                    return '**Conceito:** Momentum de curt√≠ssimo prazo. Mede a mudan√ßa percentual do pre√ßo na √∫ltima hora. √ötil para identificar picos repentinos de volume/euforia.';
                case 'Varia√ß√£o 24h':
                    return '**Conceito:** Momentum Di√°rio. Mede a mudan√ßa percentual do pre√ßo nas √∫ltimas 24 horas. Fundamental para entender o sentimento do mercado no dia.';
                case 'Varia√ß√£o 7D':
                    return '**Conceito:** Tend√™ncia de Curto Prazo. Mede a mudan√ßa percentual do pre√ßo na √∫ltima semana. Ajuda a confirmar se a tend√™ncia atual est√° se fortalecendo ou enfraquecendo.';
                case 'Varia√ß√£o 30D':
                    return '**Conceito:** Tend√™ncia de M√©dio Prazo. Mede a mudan√ßa percentual do pre√ßo no √∫ltimo m√™s. Indicador chave para mapear a fase macro do ciclo Wyckoff.';
                
                case 'Alpha vs. BTC (1h)':
                    return '**Conceito:** For√ßa Relativa de 1 hora. Compara se o ativo est√° subindo (Alpha) ou caindo (Beta) mais que o Bitcoin na √∫ltima hora. √ötil para identificar movimentos de fluxo de capital imediatos.';
                case 'Alpha vs. BTC (7D)':
                    return '**Conceito:** For√ßa Relativa Semanal. Compara se o ativo est√° subindo (Alpha) ou caindo (Beta) mais que o Bitcoin na √∫ltima semana. Alpha positivo √© sinal de que o capital est√° fluindo para este ativo.';
                case 'Alpha vs. BTC (30D)':
                    return '**Conceito:** For√ßa Relativa Mensal. O mesmo que Alpha 7D, mas em um horizonte maior de 30 dias. √â um indicador mais robusto da migra√ß√£o de capital.';

                case 'Proximidade S/R (Heur√≠stica)':
                    return '**Conceito:** Indicador de Zonas Cr√≠ticas. Identifica se o pre√ßo est√° perto de um Suporte (piso) ou Resist√™ncia (teto). Comprar perto do Suporte e vender perto da Resist√™ncia √© a base de uma boa estrat√©gia de risco/recompensa.';
                case 'RSI heur√≠stico (for√ßa relativa aproximada)':
                    return '**Conceito:** Indicador de Exaust√£o. Estima o √çndice de For√ßa Relativa. Ajuda a saber se o ativo est√° *super-comprado* (acima de 70) ou *super-vendido* (abaixo de 30).';
                case 'Score de atra√ß√£o':
                    return '**Conceito:** Score de Risco-Recompensa. Uma pontua√ß√£o de 0 a 100 que resume a atratividade de compra/acumula√ß√£o do ativo, ponderando o desconto do topo, RSI e a fase Wyckoff.';
                case 'Sinal Wyckoff (din√¢mico)':
                    return '**Conceito:** Classifica√ß√£o da Fase de Mercado. Identifica se o ativo est√° em Acumula√ß√£o (comprando), Distribui√ß√£o (vendendo), Mark-up (subindo) ou Mark-down (caindo).';

                default:
                    return 'Conceito Anal√≠tico: Esta √© a descri√ß√£o conceitual da m√©trica.';
            }
        }
        
        function drawSparkline(canvas, data) {
            if (!canvas || !data || !data.length) return;
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const width = canvas.clientWidth * dpr;
            const height = canvas.clientHeight * dpr;

            canvas.width = width;
            canvas.height = height;

            const min = Math.min(...data);
            const max = Math.max(...data);
            const range = max - min || 1;

            ctx.clearRect(0, 0, width, height);
            ctx.lineWidth = 1.3 * dpr;
            ctx.strokeStyle = '#3861fb';
            ctx.beginPath();

            data.forEach((value, index) => {
                const x = (index / (data.length - 1)) * width;
                const y = height - ((value - min) / range) * height;
                if (index === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });

            ctx.stroke();
        }

        // --- FUN√á√ÉO DE BUSCA DIN√ÇMICA (NOVA) ---

        async function searchCoinGecko(query) {
            if (query.length < 3) {
                TOKEN_SEARCH_RESULTS.innerHTML = 'Digite pelo menos 3 caracteres.';
                return;
            }
            TOKEN_SEARCH_RESULTS.innerHTML = 'Buscando...';

            try {
                const response = await fetch(`${API_BASE}/search?query=${query}`);
                if (!response.ok) throw new Error('Falha na busca CoinGecko.');
                const data = await response.json();

                if (!data.coins || data.coins.length === 0) {
                    TOKEN_SEARCH_RESULTS.innerHTML = 'Nenhum resultado encontrado.';
                    return;
                }

                let html = '';
                // Filtra para mostrar no m√°ximo 5 resultados
                data.coins.slice(0, 5).forEach(coin => {
                    const isAdded = ALL_TOKENS_CONFIG.find(t => t.id === coin.id);
                    if (isAdded) return; 

                    html += `
                        <div class="token-result-item">
                            <span>${coin.symbol.toUpperCase()} - ${coin.name}</span>
                            <button class="add-btn" 
                                onclick="addToken('${coin.symbol.toUpperCase()}', '${coin.name.replace(/'/g, "\\'")}', '${coin.id}')">
                                Adicionar
                            </button>
                        </div>
                    `;
                });

                TOKEN_SEARCH_RESULTS.innerHTML = html || 'Nenhum resultado novo encontrado.';

            } catch (error) {
                console.error("Erro na busca CoinGecko:", error);
                TOKEN_SEARCH_RESULTS.innerHTML = 'Erro ao buscar dados. Tente novamente mais tarde.';
            }
        }
        
        // --- FUN√á√ïES DE EXCLUS√ÉO DE CARD E MODAL ---
        
        window.openConfirmModal = function(id, ticker, isUserToken) {
            document.getElementById('modal-title').textContent = `Confirmar Exclus√£o de ${ticker}`;
            document.getElementById('modal-message').textContent = `Voc√™ tem certeza que deseja remover o token ${ticker} da sua lista de monitoramento? Esta a√ß√£o √© irrevers√≠vel e remover√° tamb√©m todo o hist√≥rico de alertas e trades simulados.`;
            
            // Remove o listener anterior para evitar m√∫ltiplas execu√ß√µes
            BTN_CONFIRM_DELETE.onclick = null;
            
            // Adiciona o novo listener com o contexto correto
            BTN_CONFIRM_DELETE.onclick = () => {
                removeToken(id, isUserToken); 
                closeConfirmModal();
            };

            CONFIRM_MODAL_OVERLAY.classList.add('active');
        }

        window.closeConfirmModal = function() {
            CONFIRM_MODAL_OVERLAY.classList.remove('active');
        }


        // --- FUN√á√ïES PRINCIPAIS DE DADOS E RENDERIZA√á√ÉO ---

        async function fetchMarketData() {
            const ids = ALL_TOKENS_CONFIG.map(t => t.id).join(',');
            // Incluindo sparkline e 1h, 24h, 7d, 30d, 1y.
            const url = `${API_BASE}${MARKETS_ENDPOINT}?vs_currency=usd&ids=${ids}&sparkline=true&price_change_percentage=1h,24h,7d,30d,1y`;

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        if (i < MAX_RETRIES - 1) {
                            await sleep((2 ** i) * 1000); 
                            continue;
                        } else {
                            throw new Error('Erro ao buscar dados da API do CoinGecko.');
                        }
                    }

                    const data = await response.json();
                    
                    // 1. Encontra os dados do BTC para c√°lculo de Alpha
                    const btcItem = data.find(item => item.id === 'bitcoin');
                    btcPrice = btcItem ? btcItem.current_price : null;
                    btc1hChange = btcItem ? item.price_change_percentage_1h_in_currency : null; // NOVO: 1H
                    btc24hChange = btcItem ? btcItem.price_change_percentage_24h_in_currency : null;
                    btc7dChange = btcItem ? btcItem.price_change_percentage_7d_in_currency : null;
                    btc30dChange = btcItem ? btcItem.price_change_percentage_30d_in_currency : null;
                    btc1yChange = btcItem ? btcItem.price_change_percentage_1y_in_currency : null;


                    const mappedData = data.map(item => {
                        const tokenInfo = ALL_TOKENS_CONFIG.find(t => t.id === item.id);
                        if (!tokenInfo) return null;

                        const rsiHeuristic = calculateRSIHeuristic(item.price_change_percentage_24h_in_currency, item.price_change_percentage_7d_in_currency);
                        const wyckoffDynamic = generateDynamicWyckoffSignal({...item});
                        const range = estimateFutureRange(item.current_price, item.price_change_percentage_7d_in_currency, item.price_change_percentage_30d_in_currency);
                        const srProximity = calculateSRProximity(item.current_price, range.weekLow, range.weekHigh);
                        const athDropPct = item.ath ? ((item.current_price - item.ath) / item.ath) * 100 : null;
                        const erScore = 50; 
                        const attractionScore = calculateAttractionScore(athDropPct, parseFloat(rsiHeuristic.text === 'N/D' ? '50' : rsiHeuristic.text), wyckoffDynamic.phase, erScore);
                        
                        // ALPHAS
                        const vsBtc1h = calculateVsBtcPerformance(item.price_change_percentage_1h_in_currency, btc1hChange); // NOVO: 1H
                        const vsBtc7d = calculateVsBtcPerformance(item.price_change_percentage_7d_in_currency, btc7dChange);
                        const vsBtc30d = calculateVsBtcPerformance(item.price_change_percentage_30d_in_currency, btc30dChange);
                        
                        const staticWyckoff = STATIC_WYCKOFF_CONTEXT[tokenInfo.ticker] || 
                                              STATIC_WYCKOFF_CONTEXT[tokenInfo.id] || 
                                              'Narrativa: **Sem narrativa espec√≠fica**. Contexto: Ativo dinamicamente adicionado. Nenhuma an√°lise Wyckoff est√°tica dispon√≠vel. Use a an√°lise din√¢mica.';

                        const isUserToken = USER_TOKENS_CONFIG.some(t => t.id === tokenInfo.id);

                        return {
                            ...item,
                            ticker: tokenInfo.ticker,
                            name: tokenInfo.name,
                            is_user_token: isUserToken, // Novo flag
                            rsi_heuristic: rsiHeuristic,
                            wyckoff_dynamic: wyckoffDynamic,
                            attraction_score: attractionScore,
                            static_wyckoff: staticWyckoff,
                            ath_drop_pct: athDropPct,
                            sparkline_data: item.sparkline_in_7d ? item.sparkline_in_7d.price : null,
                            market_cap_rank: item.market_cap_rank,
                            
                            // M√©tricas Estrat√©gicas
                            vs_btc_1h: vsBtc1h, // NOVO: 1H
                            vs_btc_7d: vsBtc7d,
                            vs_btc_30d: vsBtc30d,
                            sr_proximity: srProximity, 
                            range_estimates: range
                        };
                    }).filter(Boolean);

                    allCryptoData = mappedData;
                    renderAll();
                    checkAlerts(mappedData);
                    renderActiveTokensList(); 

                    document.getElementById('last-update').textContent =
                        '√öltima atualiza√ß√£o: ' + new Date().toLocaleTimeString('pt-BR');

                    startAutoRefresh();
                    return;
                } catch (error) {
                    if (i === MAX_RETRIES - 1) {
                        console.error("Falha final na busca de dados:", error);
                        CARD_CONTAINER.innerHTML = `
                            <div class="card" style="text-align:center;">
                                <p style="margin-bottom:8px;font-weight:600;color:#dc2626;">
                                    Erro ao carregar dados do CoinGecko.
                                </p>
                                <p style="margin:0 0 10px;font-size:0.76rem;color:var(--text-muted);">
                                    Ocorreu um erro de rede ou o limite de requisi√ß√µes foi atingido. Tente novamente.
                                </p>
                                <button onclick="retryFetchData()"
                                        style="border:none;border-radius:999px;padding:6px 12px;background:#3861fb;color:#fff;font-size:0.78rem;font-weight:600;cursor:pointer;">
                                    Tentar recarregar
                                </button>
                            </div>`;
                        document.getElementById('last-update').textContent =
                            '√öltima atualiza√ß√£o: falha ao acessar a API.';
                        RANKING_CONTAINER.innerHTML =
                            '<div style="text-align:center;color:#dc2626;">N√£o foi poss√≠vel carregar o ranking.</div>';
                        HIGHLIGHT_CONTAINER.innerHTML =
                            '<div style="text-align:center;grid-column:1/span 4;color:#dc2626;">N√£o foi poss√≠vel carregar os destaques.</div>';
                    }
                }
            }
        }

        function retryFetchData() {
            showToast('Atualizando dados agora...', 2000);
            fetchMarketData();
        }

        function applyFilters(data) {
            return data.filter(item => {
                if (currentWyckoffFilter !== 'all') {
                    if (item.wyckoff_dynamic.phase !== currentWyckoffFilter) return false;
                }
                if (currentSearchTerm) {
                    const term = currentSearchTerm.toLowerCase();
                    const matchTicker = item.ticker.toLowerCase().includes(term);
                    const matchName = (item.name || '').toLowerCase().includes(term);
                    if (!matchTicker && !matchName) return false;
                }
                return true;
            }).sort((a, b) => a.name.localeCompare(b.name)); 
        }

        function renderAll() {
            const filtered = applyFilters(allCryptoData);
            renderCards(filtered);
            renderRankingDashboard(allCryptoData);
            renderHighlightsDashboard(allCryptoData);
        }

        function renderCards(data) {
            if (!data || data.length === 0) {
                CARD_CONTAINER.innerHTML =
                    '<div class="card" style="text-align:center;font-size:0.8rem;">Nenhum ativo corresponde aos filtros atuais.</div>';
                return;
            }

            let html = '';
            data.forEach(item => {
                const change1h = item.price_change_percentage_1h_in_currency; 
                const change24h = item.price_change_percentage_24h_in_currency;
                const change7d = item.price_change_percentage_7d_in_currency;
                const change30d = item.price_change_percentage_30d_in_currency;
                
                const rsi = item.rsi_heuristic;
                const wyck = item.wyckoff_dynamic;
                const fib = {buy: item.current_price * 0.95, sell: item.current_price * 1.05}; 

                const vsBtc1h = item.vs_btc_1h; // NOVO: 1H
                const vsBtc7d = item.vs_btc_7d; 
                const vsBtc30d = item.vs_btc_30d; 
                const srProx = item.sr_proximity; 

                let scoreClass = 'score-mid';
                if (item.attraction_score !== null) {
                    if (item.attraction_score >= 70) scoreClass = 'score-high';
                    else if (item.attraction_score <= 40) scoreClass = 'score-low';
                }
                    
                const isUserToken = item.is_user_token; // Flag para mostrar o X

                html += `
                    <div class="card" data-ticker="${item.ticker}" data-wyckoff-phase="${wyck.phase}" data-id="${item.id}">
                        ${isUserToken ? `<button class="remove-card-btn" title="Remover da lista" onclick="openConfirmModal('${item.id}', '${item.ticker}', true)">√ó</button>` : ''}
                        
                        <div class="card-header">
                            <div class="card-left">
                                <div>
                                    <div class="ticker">${item.ticker}</div>
                                    <div class="token-name">
                                        <div class="token-info-group">
                                            ${item.name}
                                            <span class="token-rank">Rank #${item.market_cap_rank || 'N/D'}</span>
                                        </div>
                                    </div>
                                </div>
                                <span class="badge"
                                     data-ticker="${item.ticker}"
                                     data-label="Sinal Wyckoff (din√¢mico)"
                                     data-is-value="true"> 
                                    ${wyck.text}
                                </span>
                            </div>
                            <div>
                                <div class="price metric-clickable-header"
                                     data-ticker="${item.ticker}"
                                     data-label="Pre√ßo atual"
                                     data-is-value="true">
                                    ${formatPrice(item.current_price)}
                                </div>
                                <div class="price-change"></div>
                            </div>
                        </div>

                        <div class="card-main-row">
                            <div class="main-metrics">
                                
                                <div class="metric-row">
                                    <span class="metric-label metric-clickable"
                                         data-ticker="${item.ticker}"
                                         data-label="Proximidade S/R (Heur√≠stica)"
                                         data-is-value="false"> 
                                        Proximidade S/R
                                    </span>
                                    <span class="metric-value metric-clickable ${srProx.class}"
                                         data-ticker="${item.ticker}"
                                         data-label="Proximidade S/R (Heur√≠stica)"
                                         data-is-value="true"> 
                                        ${srProx.text}
                                    </span>
                                </div>

                                <div class="momentum-group">
                                    <div class="metric-row">
                                        <span class="metric-label metric-clickable"
                                             data-ticker="${item.ticker}"
                                             data-label="Varia√ß√£o 1h"
                                             data-is-value="false"> 
                                            Varia√ß√£o 1h
                                        </span>
                                        <span class="metric-value metric-clickable change-metric-value ${change1h > 0 ? 'positive' : change1h < 0 ? 'negative' : 'neutral'}"
                                             data-ticker="${item.ticker}"
                                             data-label="Varia√ß√£o 1h"
                                             data-is-value="true"> 
                                            ${formatPercent(change1h)}
                                        </span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label metric-clickable"
                                             data-ticker="${item.ticker}"
                                             data-label="Varia√ß√£o 24h"
                                             data-is-value="false"> 
                                            Varia√ß√£o 24h
                                        </span>
                                        <span class="metric-value metric-clickable change-metric-value ${change24h > 0 ? 'positive' : change24h < 0 ? 'negative' : 'neutral'}"
                                             data-ticker="${item.ticker}"
                                             data-label="Varia√ß√£o 24h"
                                             data-is-value="true"> 
                                            ${formatPercent(change24h)}
                                        </span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label metric-clickable"
                                             data-ticker="${item.ticker}"
                                             data-label="Varia√ß√£o 7D"
                                             data-is-value="false"> 
                                            Varia√ß√£o 7D
                                        </span>
                                        <span class="metric-value metric-clickable change-metric-value ${change7d > 0 ? 'positive' : change7d < 0 ? 'negative' : 'neutral'}"
                                             data-ticker="${item.ticker}"
                                             data-label="Varia√ß√£o 7D"
                                             data-is-value="true"> 
                                            ${formatPercent(change7d)}
                                        </span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label metric-clickable"
                                             data-ticker="${item.ticker}"
                                             data-label="Varia√ß√£o 30D"
                                             data-is-value="false"> 
                                            Varia√ß√£o 30D
                                        </span>
                                        <span class="metric-value metric-clickable change-metric-value ${change30d > 0 ? 'positive' : change30d < 0 ? 'negative' : 'neutral'}"
                                             data-ticker="${item.ticker}"
                                             data-label="Varia√ß√£o 30D"
                                             data-is-value="true"> 
                                            ${formatPercent(change30d)}
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="alpha-group">
                                    <div class="metric-row">
                                        <span class="metric-label metric-clickable"
                                             data-ticker="${item.ticker}"
                                             data-label="Alpha vs. BTC (1h)"
                                             data-is-value="false"> 
                                            Alpha vs. BTC (1h)
                                        </span>
                                        <span class="metric-value metric-clickable ${vsBtc1h.class}"
                                             data-ticker="${item.ticker}"
                                             data-label="Alpha vs. BTC (1h)"
                                             data-is-value="true"> 
                                            ${vsBtc1h.text}
                                        </span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label metric-clickable"
                                             data-ticker="${item.ticker}"
                                             data-label="Alpha vs. BTC (7D)"
                                             data-is-value="false"> 
                                            Alpha vs. BTC (7D)
                                        </span>
                                        <span class="metric-value metric-clickable ${vsBtc7d.class}"
                                             data-ticker="${item.ticker}"
                                             data-label="Alpha vs. BTC (7D)"
                                             data-is-value="true"> 
                                            ${vsBtc7d.text}
                                        </span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label metric-clickable"
                                             data-ticker="${item.ticker}"
                                             data-label="Alpha vs. BTC (30D)"
                                             data-is-value="false"> 
                                            Alpha vs. BTC (30D)
                                        </span>
                                        <span class="metric-value metric-clickable ${vsBtc30d.class}"
                                             data-ticker="${item.ticker}"
                                             data-label="Alpha vs. BTC (30D)"
                                             data-is-value="true"> 
                                            ${vsBtc30d.text}
                                        </span>
                                    </div>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label metric-clickable"
                                         data-ticker="${item.ticker}"
                                         data-label="RSI heur√≠stico (for√ßa relativa aproximada)"
                                         data-is-value="false"> 
                                        RSI heur√≠stico
                                    </span>
                                    <span class="metric-value metric-clickable ${rsi.class}"
                                         data-ticker="${item.ticker}"
                                         data-label="RSI heur√≠stico (for√ßa relativa aproximada)"
                                         data-is-value="true"> 
                                        ${rsi.text}
                                    </span>
                                </div>
                                
                                <div class="metric-row">
                                    <span class="metric-label metric-clickable"
                                         data-ticker="${item.ticker}"
                                         data-label="Score de atra√ß√£o"
                                         data-is-value="false"> 
                                        Score de atra√ß√£o
                                    </span>
                                    <span class="metric-value metric-clickable"
                                         data-ticker="${item.ticker}"
                                         data-label="Score de atra√ß√£o"
                                         data-is-value="true"> 
                                        ${
                                            item.attraction_score === null
                                            ? 'N/D'
                                            : `<span class="score-badge ${scoreClass}">${item.attraction_score.toFixed(0)}</span>`
                                        }
                                    </span>
                                </div>
                            </div>
                            <div class="sparkline-wrapper">
                                <canvas class="sparkline" id="sparkline-${item.ticker}"></canvas>
                            </div>
                        </div>

                        <div class="card-details">
                            <div class="wyckoff-tag">
                                <strong>Contexto Wyckoff est√°tico:</strong> ${item.static_wyckoff}
                            </div>
                            
                            <div class="alert-trade-section">
                                <h4>Simula√ß√£o de Trade e Alerta Local</h4>
                                
                                <form class="trade-form" onsubmit="event.preventDefault(); handleTradeSubmission('${item.ticker}', 'buy', ${item.current_price}, document.getElementById('buy-amount-type-${item.ticker}').value, document.getElementById('buy-amount-${item.ticker}').value); return false;">
                                    <div style="font-size:0.75rem; font-weight:600; color:var(--positive); margin-bottom: 4px;">Registrar Compra:</div>
                                    <div class="trade-form-group">
                                        <select id="buy-amount-type-${item.ticker}" onchange="updatePlaceholder('${item.ticker}', 'buy')">
                                            <option value="usd">Valor (USD)</option>
                                            <option value="quantity">Qtd. Tokens</option>
                                        </select>
                                        <input type="number" id="buy-amount-${item.ticker}" placeholder="100.00 USD" step="any" min="0.0000001" required>
                                    </div>
                                    <button type="submit" class="btn-buy" style="background-color: var(--positive); color: #ffffff;">Registrar Compra @ ${formatPrice(item.current_price)}</button>
                                </form>

                                <form class="trade-form" onsubmit="event.preventDefault(); handleTradeSubmission('${item.ticker}', 'sell', ${item.current_price}, document.getElementById('sell-amount-type-${item.ticker}').value, document.getElementById('sell-amount-${item.ticker}').value); return false;">
                                    <div style="font-size:0.75rem; font-weight:600; color:var(--negative); margin-top: 10px; margin-bottom: 4px;">Fechar Posi√ß√£o (Parcial ou Total):</div>
                                    <div class="trade-form-group">
                                        <select id="sell-amount-type-${item.ticker}" onchange="updatePlaceholder('${item.ticker}', 'sell')">
                                            <option value="quantity">Qtd. Tokens</option>
                                            <option value="usd">Valor (USD)</option>
                                        </select>
                                        <input type="number" id="sell-amount-${item.ticker}" placeholder="Qtd. de tokens para vender" step="any" min="0.0000001" required>
                                    </div>
                                    <button type="submit" class="btn-sell" style="background-color: var(--negative); color: #ffffff;">Fechar/Vender @ ${formatPrice(item.current_price)}</button>
                                </form>

                                <form class="trade-form" onsubmit="event.preventDefault(); addAlert('${item.ticker}', document.getElementById('alert-type-${item.ticker}').value, document.getElementById('alert-price-${item.ticker}').value); return false;">
                                    <div style="font-size:0.75rem; font-weight:600; color:var(--accent-strong); margin-top: 10px; margin-bottom: 4px;">Alerta de Pre√ßo:</div>
                                    <select id="alert-type-${item.ticker}" required style="width: 100%; margin-bottom: 6px; padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border-card); font-size: 0.75rem;">
                                        <option value="buy">Alvo de COMPRA (entrada)</option>
                                        <option value="sell">Alvo de VENDA (sa√≠da)</option>
                                    </select>
                                    <input type="number" id="alert-price-${item.ticker}" placeholder="Pre√ßo alvo em USD (ex: ${fib.buy ? fib.buy.toFixed(2) : '0.00'})" step="any" required style="width: 100%; margin-bottom: 6px; padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border-card); font-size: 0.75rem;">
                                    <button type="submit">Salvar alerta de pre√ßo</button>
                                </form>

                                <div class="active-alerts-list"></div>
                                <div class="trade-history-list"></div>
                            </div>
                            
                            <div class="tradingview-container" id="tv-${item.ticker}"></div>
                        </div>
                    </div>
                `;
            });

            CARD_CONTAINER.innerHTML = html;

            document.querySelectorAll('.card').forEach(card => {
                const ticker = card.getAttribute('data-ticker');
                card.addEventListener('click', (e) => {
                    // Impede que o clique nos bot√µes de trade/alerta/excluir expanda/recolha o card
                    if (e.target.closest('.alert-trade-section') || e.target.closest('.metric-tooltip-overlay') || e.target.closest('.remove-card-btn')) return;

                    const expanded = card.classList.toggle('expanded');
                    if (expanded) {
                        initTradingViewWidget(ticker);
                        renderCardAlerts(ticker);
                        renderCardTrades(ticker);
                        updatePlaceholder(ticker, 'buy'); // Garante placeholder inicial correto
                        updatePlaceholder(ticker, 'sell'); 
                    }
                });
            });

            document.querySelectorAll('.metric-label, .metric-value, .metric-clickable-header, .detail-label, .detail-value').forEach(el => {
                el.addEventListener('click', () => {
                    const ticker = el.getAttribute('data-ticker');
                    const label = el.getAttribute('data-label');
                    const isValue = el.getAttribute('data-is-value') === 'true'; 
                    
                    const item = allCryptoData.find(c => c.ticker === ticker);
                    if (!item) return;

                    let value;
                    let type = el.getAttribute('data-type');
                    
                    if (label.startsWith('Alpha vs. BTC (1h)')) {
                         value = item.vs_btc_1h.value; 
                    } else if (label.startsWith('Alpha vs. BTC (7D)')) {
                         value = item.vs_btc_7d.value; 
                    } else if (label.startsWith('Alpha vs. BTC (30D)')) {
                         value = item.vs_btc_30d.value; 
                    } else if (label === 'Proximidade S/R (Heur√≠stica)' && isValue) {
                        value = item.sr_proximity.value; 
                    } else if (label === 'RSI heur√≠stico (for√ßa relativa aproximada)' && isValue) {
                        value = item.rsi_heuristic.value;
                    } else if (label === 'Varia√ß√£o 1h' && isValue) {
                        value = item.price_change_percentage_1h_in_currency; 
                    } else if (label === 'Varia√ß√£o 7D' && isValue) {
                        value = item.price_change_percentage_7d_in_currency;
                    } else if (label === 'Varia√ß√£o 30D' && isValue) {
                        value = item.price_change_percentage_30d_in_currency;
                    } else if (label === 'Varia√ß√£o 24h' && isValue) {
                        value = item.price_change_percentage_24h_in_currency;
                    } else if (label === 'Score de atra√ß√£o' && isValue) {
                        value = item.attraction_score;
                    } else if (label === 'Sinal Wyckoff (din√¢mico)' && isValue) {
                         value = item.wyckoff_dynamic.text;
                    } else if (label === 'Pre√ßo atual' && isValue) {
                        value = item.current_price;
                    } else if (type === 'number' && isValue) {
                         value = parseFloat(el.getAttribute('data-value')); 
                    } else {
                         value = el.getAttribute('data-value');
                    }


                    const text = getAnalyticalInterpretation(label, value, item, isValue);
                    
                    let title = isValue ? `${ticker} ‚Ä¢ An√°lise: ${label}` : `${ticker} ‚Ä¢ Conceito: ${label}`;
                    openMetricTooltip(title, text);
                });
            });

            data.forEach(item => {
                const canvas = document.getElementById('sparkline-' + item.ticker);
                if (canvas && item.sparkline_data) {
                    drawSparkline(canvas, item.sparkline_data);
                }
            });
        }
        
        // --- FUN√á√ïES DE L√ìGICA DE TRADE ---

        function updatePlaceholder(ticker, type) {
            const currentPrice = allCryptoData.find(c => c.ticker === ticker)?.current_price || 0;
            if (type === 'buy') {
                const typeEl = document.getElementById(`buy-amount-type-${ticker}`);
                const inputEl = document.getElementById(`buy-amount-${ticker}`);
                if (typeEl.value === 'usd') {
                    inputEl.placeholder = 'Ex: 100.00 USD';
                } else {
                    inputEl.placeholder = `Ex: ${100 / currentPrice || 1} tokens`;
                }
            } else if (type === 'sell') {
                const typeEl = document.getElementById(`sell-amount-type-${ticker}`);
                const inputEl = document.getElementById(`sell-amount-${ticker}`);
                const openTrade = tradeHistory[ticker] ? tradeHistory[ticker].find(t => t.type === 'BUY' && !t.closed) : null;
                const maxQty = openTrade ? openTrade.quantity : 0;
                
                if (typeEl.value === 'usd') {
                    inputEl.placeholder = 'Ex: 50.00 USD';
                } else {
                    inputEl.placeholder = `Qtd. a vender (Max: ${formatTokenCount(maxQty)})`;
                }
            }
        }

        function handleTradeSubmission(ticker, type, currentPrice, amountType, inputAmount) {
            const amount = parseFloat(inputAmount);
            if (isNaN(amount) || amount <= 0) {
                showToast("Por favor, insira um valor v√°lido e positivo.", 3000);
                return;
            }

            let quantity = 0;
            let totalValue = 0;
            
            if (type === 'buy') {
                if (amountType === 'usd') {
                    totalValue = amount;
                    quantity = amount / currentPrice;
                } else { // quantity
                    quantity = amount;
                    totalValue = amount * currentPrice;
                }
                registerTrade(ticker, 'buy', currentPrice, quantity, totalValue, currentPrice);
            } 
            
            else if (type === 'sell') {
                const openTrade = tradeHistory[ticker] ? tradeHistory[ticker].find(t => t.type === 'BUY' && !t.closed) : null;

                if (!openTrade || openTrade.quantity <= 0.0000001) {
                    showToast(`Erro: N√£o h√° posi√ß√£o de COMPRA aberta para ${ticker} para fechar.`, 4000);
                    return;
                }

                if (amountType === 'usd') {
                    totalValue = amount;
                    quantity = amount / currentPrice;
                } else { // quantity
                    quantity = amount;
                    totalValue = amount * currentPrice;
                }

                if (quantity > openTrade.quantity) {
                    showToast(`Aten√ß√£o: Quantidade vendida (${formatTokenCount(quantity)}) √© maior que a posi√ß√£o aberta (${formatTokenCount(openTrade.quantity)}). Fechando o total da posi√ß√£o.`, 5000);
                    quantity = openTrade.quantity; 
                }

                registerTrade(ticker, 'sell', currentPrice, quantity, totalValue, currentPrice);
            }
            
            // Limpa o campo de input ap√≥s o registro
            document.getElementById(`${type}-amount-${ticker}`).value = '';
            // For√ßa a atualiza√ß√£o dos placeholders (ex: quantidade m√°xima dispon√≠vel para venda)
            updatePlaceholder(ticker, type); 
        }

        function initTradingViewWidget(ticker) {
            const containerId = 'tv-' + ticker;
            const container = document.getElementById(containerId);
            if (!container || container.getAttribute('data-loaded') === '1') return;

            const symbol = getTradingViewSymbol(ticker);
            container.setAttribute('data-loaded', '1');

            new TradingView.widget({
                autosize: true,
                symbol: symbol,
                interval: '60',
                timezone: 'Etc/UTC',
                theme: 'light',
                style: '1',
                locale: 'br',
                toolbar_bg: '#f1f3f6',
                enable_publishing: false,
                hide_top_toolbar: true,
                hide_legend: true,
                save_image: false,
                container_id: containerId
            });
        }

        function renderHighlightsDashboard(data) {
            if (!data || data.length === 0) {
                HIGHLIGHT_CONTAINER.innerHTML =
                    '<div style="text-align:center;grid-column:1/span 4;">Sem dados para destaques.</div>';
                return;
            }

            // 1. TOP 10 Valorizadas (24h)
            const topValued = [...data].sort((a, b) => (b.price_change_percentage_24h_in_currency || -Infinity) - (a.price_change_percentage_24h_in_currency || -Infinity)).slice(0, 10);
            // 2. TOP 10 Desvalorizadas (24h)
            const topDevalued = [...data].sort((a, b) => (a.price_change_percentage_24h_in_currency || Infinity) - (b.price_change_percentage_24h_in_currency || Infinity)).slice(0, 10);
            // 3. TOP 10 Ativos mais fortes (Maior Score de Atra√ß√£o)
            const topStrong = [...data].sort((a, b) => (b.attraction_score || -Infinity) - (a.attraction_score || -Infinity)).slice(0, 10);
            // 4. TOP 10 Ativos mais fracos (Menor RSI Heur√≠stico - sugere sobre-venda extrema)
            const topWeak = [...data].sort((a, b) => (a.rsi_heuristic.value || Infinity) - (b.rsi_heuristic.value || Infinity)).slice(0, 10);

            let html = `
                <div class="highlight-card">
                    <h4>Top Valorizadas (24h) üöÄ</h4>
                    ${topValued.map(i => `
                        <div class="highlight-item"
                            data-ticker="${i.ticker}"
                            data-label="Top Valorizadas (24h)"
                            onclick="openTooltipFromHighlight('${i.ticker}', 'Top Valorizadas (24h)')">
                            <span>${i.ticker}</span>
                            <span class="positive">${formatPercent(i.price_change_percentage_24h_in_currency)}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="highlight-card">
                    <h4>Top Desvalorizadas (24h) üîª</h4>
                    ${topDevalued.map(i => `
                        <div class="highlight-item"
                            data-ticker="${i.ticker}"
                            data-label="Top Desvalorizadas (24h)"
                            onclick="openTooltipFromHighlight('${i.ticker}', 'Top Desvalorizadas (24h)')">
                            <span>${i.ticker}</span>
                            <span class="negative">${formatPercent(i.price_change_percentage_24h_in_currency)}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="highlight-card">
                    <h4>Top Atra√ß√£o (Forte Compra) ‚≠ê</h4>
                    ${topStrong.map(i => `
                        <div class="highlight-item"
                            data-ticker="${i.ticker}"
                            data-label="Top Atra√ß√£o (Forte Compra)"
                            onclick="openTooltipFromHighlight('${i.ticker}', 'Top Atra√ß√£o (Forte Compra)')">
                            <span>${i.ticker}</span>
                            <span class="score-badge ${i.attraction_score >= 70 ? 'score-high' : 'score-mid'}">${i.attraction_score === null ? 'N/D' : i.attraction_score.toFixed(0)}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="highlight-card">
                    <h4>Top Sobre-venda (Fraco) üìâ</h4>
                    ${topWeak.map(i => `
                        <div class="highlight-item"
                            data-ticker="${i.ticker}"
                            data-label="Top Sobre-venda (Fraco)"
                            onclick="openTooltipFromHighlight('${i.ticker}', 'Top Sobre-venda (Fraco)')">
                            <span>${i.ticker}</span>
                            <span class="rsi-low">${i.rsi_heuristic.text}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            HIGHLIGHT_CONTAINER.innerHTML = html;

            document.querySelectorAll('.highlight-item').forEach(el => {
                el.addEventListener('click', (e) => {
                    const ticker = el.getAttribute('data-ticker');
                    if (e.target.tagName !== 'SPAN' && !e.target.closest('.metric-tooltip-overlay')) {
                        const card = document.querySelector(`.card[data-ticker="${ticker}"]`);
                        if (!card) return;
                        card.classList.add('expanded');
                        initTradingViewWidget(ticker);
                        renderCardAlerts(ticker);
                        renderCardTrades(ticker);
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            });
        }

        window.openTooltipFromHighlight = function(ticker, label) {
            const item = allCryptoData.find(c => c.ticker === ticker);
            if (!item) return;
            
            let value;
            if (label === 'Top Valorizadas (24h)' || label === 'Top Desvalorizadas (24h)') {
                value = item.price_change_percentage_24h_in_currency;
            } else if (label === 'Top Atra√ß√£o (Forte Compra)') {
                value = item.attraction_score;
            } else if (label === 'Top Sobre-venda (Fraco)') {
                value = item.rsi_heuristic.value;
            }
            
            const text = getAnalyticalInterpretation(label, value, item, true);
            openMetricTooltip(`${ticker} ‚Ä¢ An√°lise: ${label}`, text);
        }

        function renderRankingDashboard(data) {
            if (!data || data.length === 0) {
                RANKING_CONTAINER.innerHTML =
                    '<div style="text-align:center;">Sem dados para ranking.</div>';
            return;
            }

            let filtered = [...data];
            if (currentDashboardFilter === 'compra') {
                filtered = filtered.filter(i => i.wyckoff_dynamic.phase === 'acc');
                filtered.sort((a, b) => (b.attraction_score || 0) - (a.attraction_score || 0));
            } else if (currentDashboardFilter === 'venda') {
                filtered = filtered.filter(i => i.wyckoff_dynamic.phase === 'dist');
                filtered.sort((a, b) => (b.price_change_percentage_30d_in_currency || 0) -
                                        (a.price_change_percentage_30d_in_currency || 0));
            } else {
                filtered.sort((a, b) => (b.attraction_score || 0) - (a.attraction_score || 0));
            }

            const top = filtered.slice(0, 8);

            let html = `
                <div class="ranking-columns">
                    <div class="ranking-card">
                        <h4>Top assimetria (score)</h4>
                        ${top.map(i => `
                            <div class="ranking-item" data-ticker="${i.ticker}">
                                <span>${i.ticker}</span>
                                <span>${i.attraction_score === null ? 'N/D' : i.attraction_score.toFixed(0)}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="ranking-card">
                        <h4>Movimento em 30 dias</h4>
                        ${top.map(i => `
                            <div class="ranking-item" data-ticker="${i.ticker}">
                                <span>${i.ticker}</span>
                                <span>${formatPercent(i.price_change_percentage_30d_in_currency)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            RANKING_CONTAINER.innerHTML = html;

            document.querySelectorAll('.ranking-item').forEach(el => {
                el.addEventListener('click', () => {
                    const ticker = el.getAttribute('data-ticker');
                    const card = document.querySelector(`.card[data-ticker="${ticker}"]`);
                    if (!card) return;
                    card.classList.add('expanded');
                    initTradingViewWidget(ticker);
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
            });
        }

        function startAutoRefresh() {
            if (refreshTimer) clearTimeout(refreshTimer);
            if (countdownTimer) clearInterval(countdownTimer);

            countdownSeconds = REFRESH_INTERVAL_MS / 1000;
            document.getElementById('countdown').textContent = countdownSeconds + 's';

            countdownTimer = setInterval(() => {
                countdownSeconds--;
                if (countdownSeconds <= 0) {
                    clearInterval(countdownTimer);
                    fetchMarketData();
                } else {
                    document.getElementById('countdown').textContent = countdownSeconds + 's';
                }
            }, 1000);
        }

        // Fun√ß√µes de Rolagem
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function scrollToBottom() {
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }


        function setupEventListeners() {
            document.getElementById('refresh-button').addEventListener('click', () => {
                showToast('Atualizando dados agora...', 2000);
                fetchMarketData();
            });
            
            document.getElementById('scroll-to-top').addEventListener('click', scrollToTop);
            document.getElementById('scroll-to-bottom').addEventListener('click', scrollToBottom);

            document.getElementById('search-input').addEventListener('input', e => {
                currentSearchTerm = e.target.value.trim();
                renderAll();
            });
            
            let searchTimeout;
            TOKEN_SEARCH_INPUT.addEventListener('input', e => {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                searchTimeout = setTimeout(() => {
                    searchCoinGecko(query);
                }, 500); 
            });


            document.querySelectorAll('input[name="wyckoff-filter"]').forEach(r => {
                r.addEventListener('change', e => {
                    currentWyckoffFilter = e.target.value;
                    document.querySelectorAll('#wyckoff-filter-group label').forEach(lbl => {
                        lbl.classList.remove('active');
                    });
                    e.target.parentElement.classList.add('active');
                    renderAll();
                });
            });

            document.querySelectorAll('input[name="dashboard-filter"]').forEach(r => {
                r.addEventListener('change', e => {
                    currentDashboardFilter = e.target.value;
                    document.querySelectorAll('#dashboard-filter-group label').forEach(lbl => {
                        lbl.classList.remove('active');
                    });
                    e.target.parentElement.classList.add('active');
                    renderRankingDashboard(allCryptoData);
                });
            });
        }

        // Adiciona as fun√ß√µes ao escopo global para que o onclick inline funcione
        window.addToken = addToken;
        window.removeToken = removeToken;
        window.openConfirmModal = openConfirmModal;
        window.closeConfirmModal = closeConfirmModal;
        window.handleTradeSubmission = handleTradeSubmission;
        window.updatePlaceholder = updatePlaceholder;


        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromStorage(); 
            setupEventListeners();
            fetchMarketData();
        });
    </script>
</body>
</html>
